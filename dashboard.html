<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Krishi-Verse</title>
    <link rel="stylesheet" href="dashboard.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <!-- Leaflet CSS For Maps-->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script
      src="https://kit.fontawesome.com/a076d05399.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js CDN -->
    <script>
      if (localStorage.getItem("loggedIn") !== "true") {
        window.location.href = "login.html";
      }
    </script>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <h2 class="logo">Krishi-Verse</h2>
        <div class="user">
          <img src="panda.jpeg" alt="User" />
          <p id="displayUsername">
            Loading...<br /><span id="displayRole">Role</span>
          </p>
        </div>
        <nav>
          <ul>
            <li>
              <a href="#" data-page="home"><i class="fas fa-home"></i> Home</a>
            </li>
            <li>
              <a href="#" data-page="product"
                ><i class="fas fa-box"></i> Products</a
              >
            </li>
            <li>
              <a href="#" data-page="warehouse"
                ><i class="fas fa-warehouse"></i> Warehouse</a
              >
            </li>
            <li>
              <a href="#" data-page="documents"
                ><i class="fas fa-file-alt"></i> Documents</a
              >
            </li>
            <li>
              <a href="#" data-page="consumers"
                ><i class="fas fa-users"></i> Consumers</a
              >
            </li>
            <li>
              <a href="#" data-page="transportation"
                ><i class="fas fa-tools"></i> Transportation</a
              >
            </li>
            <li>
              <a href="#" data-page="inventory"
                ><i class="fas fa-chart-line"></i>Inventory</a
              >
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <div class="main">
        <header>
          <div class="header-right">
            <a href="#" class="notification-btn">Notification</a>
            <a href="#" class="message-btn">Message</a>
            <div class="profile-dropdown">
              <a href="#" class="profile-btn" onclick="toggleDropdown(event)"
                >Profile <i class="fas fa-caret-down"></i
              ></a>
              <div id="dropdown-menu" class="dropdown-content">
                <a href="#">Edit Profile</a>
                <a href="#">Settings</a>
              </div>
            </div>
            <a href="#" onclick="logout()" class="logout-btn">Logout</a>
          </div>
        </header>

        <section class="content">
          <!-- Content will be dynamically loaded here -->
        </section>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const username = localStorage.getItem("username") || "User";
        const role = localStorage.getItem("designation") || "warehouseManager";

        // Update DOM elements with the stored values
        document.getElementById(
          "displayUsername"
        ).innerHTML = `${username}<br><span>${formatRole(role)}</span>`;
      });

      function formatRole(role) {
        switch (role) {
          case "warehouseManager":
            return "Warehouse-Manager";
          case "supplier":
            return "Supplier";
          case "transporter":
            return "Transporter";
          case "distributor":
            return "Distributor";
          case "retailer":
            return "Retailer";
          default:
            return role;
        }
      }

      // Redirect if not logged in
      function logout() {
        localStorage.removeItem("loggedIn");
        window.location.href = "index.html";
      }

      function toggleDropdown(e) {
        e.preventDefault();
        const menu = document.getElementById("dropdown-menu");
        menu.classList.toggle("show");
      }

      window.addEventListener("click", function (e) {
        if (!e.target.closest(".profile-dropdown")) {
          document.getElementById("dropdown-menu").classList.remove("show");
        }
      });

      const links = document.querySelectorAll("nav a");
      const contentArea = document.querySelector(".content");

      links.forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          const page = this.getAttribute("data-page");
          loadContent(page);
        });
      });

      function loadContent(page) {
        fetch(`${page}.html?v=${new Date().getTime()}`)
          .then((res) => res.text())
          .then((data) => {
            contentArea.innerHTML = data;

            if (page === "product") initProductPage();
            if (page === "warehouse") initWarehousePage();
            if (page === "consumers") initConsumerPage();
            if (page === "home") {
              loadHomeChart();
              renderTransportationChart();
              loadHomeConsumers();
            }
            if (page === "transportation") initTransportationPage();
            if (page === "documents") initDocumentPage();
            if (page === "inventory") initInventoryPage();
          })
          .catch((err) => {
            contentArea.innerHTML = `<p>Error loading ${page} content.</p>`;
          });
      }
      function loadHomeConsumers() {
        fetch("consumers.php")
          .then((res) => {
            if (!res.ok) throw new Error("Network response was not ok");
            return res.json();
          })
          .then((data) => {
            if (data.success && data.counts) {
              document.getElementById("totalFarmers").textContent =
                data.counts.farmers || 0;
              document.getElementById("totalSuppliers").textContent =
                data.counts.suppliers || 0;
              document.getElementById("totalCustomers").textContent =
                data.counts.customers || 0;
            } else {
              console.error("Invalid counts data from consumers.php", data);
            }
          })
          .catch((err) => console.error("Error loading home counts:", err));
      }

      function loadHomeChart() {
        fetch("product.php?action=list")
          .then((res) => res.json())
          .then((products) => {
            const productNames = [];
            const productPrices = [];

            products.forEach((product) => {
              const name = product.productName;
              const price = parseFloat(product.price);

              if (name && !isNaN(price)) {
                productNames.push(name);
                productPrices.push(price);
              }
            });

            const ctx = document
              .getElementById("productChart")
              ?.getContext("2d");
            if (ctx) {
              new Chart(ctx, {
                type: "bar",
                data: {
                  labels: productNames,
                  datasets: [
                    {
                      label: "Price (Bdt/kg)",
                      data: productPrices,
                      backgroundColor: [
                        "#5B5EA6",
                        "#76B947",
                        "#E94B3C",
                        "#007F5C",
                        "#FFD700",
                        "#FF6F61",
                        "#6B5B95",
                      ],
                      borderRadius: 8,
                    },
                  ],
                },
                options: {
                  responsive: true,
                  scales: {
                    y: {
                      beginAtZero: true,
                      title: {
                        display: true,
                        text: "Price (Bdt/kg)",
                      },
                    },
                  },
                  plugins: {
                    title: {
                      display: true,
                      text: "Products Vs Price Index",
                    },
                    legend: {
                      display: false,
                    },
                  },
                },
              });
            }
          })
          .catch((error) => {
            console.error("Error loading product data for chart:", error);
          });
      }

      // Call the function once the page loads
      window.addEventListener("DOMContentLoaded", loadHomeChart);

      //--transport Dummy Graph-----------
      function renderTransportationChart() {
        const ctx = document.getElementById("transportChart").getContext("2d");

        new Chart(ctx, {
          type: "line",
          data: {
            labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"],
            datasets: [
              {
                label: "Transportation Cost ($)",
                data: [1200, 1350, 1100, 1450, 1600, 1550, 1700],
                borderColor: "rgba(75, 192, 192, 1)",
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                fill: true,
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "top" },
              title: { display: true, text: "Monthly Transportation Cost" },
            },
            scales: { y: { beginAtZero: false } },
          },
        });
      }

      // ---------- Transportation Page Logic ----------
      function initTransportationPage() {
        const modal = document.getElementById("scheduleModal");
        const scheduleBtn = document.querySelector(".schedule-btn");
        const form = document.querySelector(".schedule-form");
        const tableBody = document.querySelector(".transport-table tbody");

        const summaryActiveRoutes = document.querySelector(
          ".summary-cards .card:nth-child(1) .value"
        );
        const summaryScheduledToday = document.querySelector(
          ".summary-cards .card:nth-child(1) .sub"
        );
        const availableVehiclesCount = document.querySelector(
          ".summary-cards .card:nth-child(2) .value"
        );

        const vehicleList = [
          "RT-001",
          "RT-002",
          "DC-003",
          "DC-004",
          "DC-005",
          "DC-006",
          "DC-007",
        ];
        const searchInput = document.getElementById("transportSearch");
        const mapContainer = document.getElementById("mapContainer");
        let map = null;
        let mapInitialized = false;

        if (!modal || !scheduleBtn || !form || !tableBody)
          return console.warn("Transportation page elements not found.");

        let transports = [];

        // Load origin warehouses
        function loadOriginWarehouses() {
          const originSelect = form.origin;
          originSelect.innerHTML =
            "<option disabled selected>Select origin</option>";
          return fetch("transportation.php?warehouses=1")
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                data.warehouses.forEach((name) => {
                  const option = document.createElement("option");
                  option.textContent = name;
                  option.value = name;
                  originSelect.appendChild(option);
                });
              } else alert("Failed to load warehouse data.");
            })
            .catch(() => alert("Error loading warehouse data."));
        }

        // Load products
        function loadProducts() {
          const productSelect = form.product;
          productSelect.innerHTML =
            "<option disabled selected>Select product</option>";
          return fetch("transportation.php?products=1")
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                data.products.forEach((name) => {
                  const option = document.createElement("option");
                  option.textContent = name;
                  option.value = name;
                  productSelect.appendChild(option);
                });
              } else alert("Failed to load product data.");
            })
            .catch(() => alert("Error loading product data."));
        }

        // Open modal
        scheduleBtn.onclick = () => {
          form.reset();
          form.setAttribute("data-editing", "false");
          form.editingRow = null;
          Promise.all([loadOriginWarehouses(), loadProducts()]).then(
            () => (modal.style.display = "block")
          );
        };

        // Close modal
        modal.addEventListener("click", (e) => {
          if (e.target === modal) modal.style.display = "none";
        });
        modal.querySelector(".close").onclick = () =>
          (modal.style.display = "none");
        form.querySelector(".cancel-btn").onclick = () =>
          (modal.style.display = "none");

        // Render transports
        function renderTransports() {
          tableBody.innerHTML = "";
          transports.forEach((t) => {
            const routeId =
              t.id || "TRP-" + Math.floor(Math.random() * 900 + 100);
            const routeText = `${t.origin} → ${t.destination}<br><small>${t.product} (${t.weight})</small>`;
            const vehicleDriver = `🚛 ${t.vehicle}<br>👤 ${t.driver}`;
            const scheduleText = `${t.schedule_date}<br>${t.schedule_time}`;
            const distance = `${t.distance} km<br><small>ETA: ${Math.floor(
              Math.random() * 3 + 1
            )} hrs</small>`;
            const priorityTag = `<span class="priority ${t.priority.toLowerCase()}">${
              t.priority
            }</span>`;
            const statusTag = `<span class="status ${t.status.toLowerCase()}">${
              t.status
            }</span>`;
            const cost = `${t.costing.toFixed(2)} BDT`;

            const row = document.createElement("tr");
            row.dataset.id = t.id;
            row.innerHTML = `
        <td>${routeId}</td>
        <td>${routeText}</td>
        <td><button class="map-btn" data-origin="${t.origin}" data-destination="${t.destination}">Map</button></td>
        <td>${vehicleDriver}</td>
        <td>${scheduleText}</td>
        <td>${distance}</td>
        <td>${priorityTag}</td>
        <td>${statusTag}</td>
        <td>${cost}</td>
        <td>${t.temperature}</td>
        <td>${t.humidity}</td>
        <td>
          <button class="edit-btn">Edit</button>
          <button class="delete-btn">Delete</button>
        </td>`;
            tableBody.appendChild(row);
          });

          bindEditDeleteButtons();
          bindMapButtons();
          updateSummaryCards();
          updateFleetStatus();
        }

        // Load transports
        function loadTransports() {
          fetch("transportation.php")
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                transports = data.transports;
                renderTransports();
              } else alert("Failed to load transport data.");
            })
            .catch(() => alert("Error loading transport data."));
        }

        // Handle add/edit form
        form.onsubmit = (e) => {
          e.preventDefault();
          const postData = new URLSearchParams({
            origin: form.origin.value.trim(),
            destination: form.destination.value.trim(),
            product: form.product.value,
            weight: form.weight.value.trim(),
            vehicle: form.vehicle.value,
            driver: form.driver.value,
            date: form.date.value,
            time: form.time.value,
            priority: form.priority.value,
            temperature: form.temperature.value,
            humidity: form.humidity.value,
            distance: parseFloat(form.distance.value) || 0,
          });

          if (form.getAttribute("data-editing") === "true" && form.editingRow) {
            postData.append("action", "update");
            postData.append("id", form.editingRow.dataset.id);
          }

          fetch("transportation.php", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: postData.toString(),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                transports = data.transports;
                renderTransports();
                modal.style.display = "none";
                form.reset();
                form.setAttribute("data-editing", "false");
                form.editingRow = null;
              } else
                alert(data.message || "Failed to save transportation record.");
            })
            .catch(() => alert("Error submitting transportation record."));
        };

        // Bind edit/delete
        function bindEditDeleteButtons() {
          tableBody.querySelectorAll(".edit-btn").forEach(
            (btn) =>
              (btn.onclick = (e) => {
                const row = e.target.closest("tr");
                const cells = row.querySelectorAll("td");
                const [routePart, productPart] =
                  cells[1].innerHTML.split("<br><small>");
                const [originText, destinationText] = routePart
                  .split("→")
                  .map((s) => s.trim());
                const productName = productPart
                  .replace(")</small>", "")
                  .split("(")[0]
                  .trim();
                const weight = productPart.match(/\(([^)]+)\)/)[1];

                form.setAttribute("data-editing", "true");
                form.editingRow = row;
                Promise.all([loadOriginWarehouses(), loadProducts()]).then(
                  () => {
                    form.origin.value = originText;
                    form.destination.value = destinationText;
                    form.product.value = productName;
                    form.weight.value = weight;
                    form.vehicle.value = cells[3].innerText
                      .split("\n")[0]
                      .replace("🚛 ", "")
                      .trim();
                    form.driver.value = cells[3].innerText
                      .split("\n")[1]
                      .replace("👤 ", "")
                      .trim();
                    form.date.value = cells[4].innerText.split("\n")[0];
                    form.time.value = cells[4].innerText.split("\n")[1];
                    form.priority.value = cells[6].innerText.trim();
                    form.distance.value = parseFloat(cells[5].innerText) || "";
                    form.temperature.value = cells[9].innerText;
                    form.humidity.value = cells[10].innerText;
                    modal.style.display = "block";
                  }
                );
              })
          );

          tableBody.querySelectorAll(".delete-btn").forEach(
            (btn) =>
              (btn.onclick = (e) => {
                if (!confirm("Are you sure you want to delete this route?"))
                  return;
                const row = e.target.closest("tr");
                fetch("transportation.php", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                  },
                  body: new URLSearchParams({
                    action: "delete",
                    id: row.dataset.id,
                  }).toString(),
                })
                  .then((res) => res.json())
                  .then((data) => {
                    if (data.success) {
                      transports = data.transports;
                      renderTransports();
                    } else
                      alert(
                        data.message ||
                          "Failed to delete transportation record."
                      );
                  })
                  .catch(() => alert("Error deleting transportation record."));
              })
          );
        }

        // Bind Map buttons
        function bindMapButtons() {
          tableBody.querySelectorAll(".map-btn").forEach(
            (btn) =>
              (btn.onclick = () => {
                const origin = btn.dataset.origin;
                const destination = btn.dataset.destination;
                mapContainer.style.display = "block";

                if (!mapInitialized) {
                  map = L.map("transportMap").setView([23.685, 90.3563], 7);
                  L.tileLayer(
                    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                    {
                      attribution:
                        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    }
                  ).addTo(map);
                  mapInitialized = true;
                } else map.invalidateSize();

                plotRoute(origin, destination);
              })
          );
        }

        // Update summary cards
        function updateSummaryCards() {
          const rows = tableBody.querySelectorAll("tr");
          const today = new Date().toISOString().split("T")[0];
          let scheduledToday = 0;
          rows.forEach((row) => {
            if (row.cells[4].innerText.split("\n")[0] === today)
              scheduledToday++;
          });
          summaryActiveRoutes.textContent = rows.length;
          summaryScheduledToday.textContent = `${scheduledToday} scheduled for today`;
        }

        // Update fleet status
        function updateFleetStatus() {
          const usedVehicles = Array.from(tableBody.querySelectorAll("tr")).map(
            (row) =>
              row.cells[3].innerText.split("\n")[0].replace("🚛 ", "").trim()
          );
          const available = vehicleList.filter(
            (v) => !usedVehicles.includes(v)
          );
          availableVehiclesCount.textContent = available.length;
        }

        // Search
        if (searchInput) {
          searchInput.addEventListener("keyup", () => {
            const filter = searchInput.value.toLowerCase();
            Array.from(tableBody.getElementsByTagName("tr")).forEach((row) => {
              row.style.display = row.innerText.toLowerCase().includes(filter)
                ? ""
                : "none";
            });
          });
        }

        // Initial load
        loadTransports();
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", initTransportationPage);

      // ---------- Product Page Logic ----------

      let editingRow = null;
      let editingId = null; // track productID when editing

      function editProduct(button) {
        const row = button.closest("tr");
        const cells = row.querySelectorAll("td");
        const modal = document.getElementById("addProductModal");
        const form = document.getElementById("addProductForm");

        if (!form || !modal) return;

        editingRow = row;
        editingId = cells[0].textContent;

        form.elements["productID"].value = cells[0].textContent;
        form.elements["productName"].value = cells[1].textContent;
        form.elements["category"].value = cells[2].textContent;
        form.elements["price"].value = cells[3].textContent;
        form.elements["packaging"].value = cells[4].textContent;
        form.elements["location"].value = cells[6].textContent;

        const statusSpan = cells[5].querySelector("span");
        form.elements["status"].value =
          statusSpan && statusSpan.textContent.includes("In Stock")
            ? "in-stock"
            : "stock-out";

        form.elements["plantingDate"].value = cells[7].textContent;
        form.elements["harvestDate"].value = cells[8].textContent;
        form.elements["shelfLife"].value = cells[9].textContent; // Optimise Shelf Life
        form.elements["storageTemp"].value = cells[10].textContent; // Optimise Storage Temp
        form.elements["humidity"].value = cells[11].textContent; // Optimise Humidity

        modal.style.display = "block";
      }

      function deleteProduct(button) {
        if (!confirm("Are you sure you want to delete this product?")) return;

        const row = button.closest("tr");
        const productID = row.cells[0].textContent;

        fetch(`product.php?action=delete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productID }),
        })
          .then((res) => res.json())
          .then((response) => {
            alert(response.message);
            if (response.success) {
              row.remove();
            }
          })
          .catch((err) => {
            alert("Failed to delete product");
            console.error(err);
          });
      }

      function initProductPage() {
        const addProductBtn = document.getElementById("addProductBtn");
        const modal = document.getElementById("addProductModal");
        const closeModal = document.getElementById("closeModal");
        const form = document.getElementById("addProductForm");
        const searchInput = document.getElementById("searchInput");
        const categoryFilter = document.getElementById("categoryFilter");
        const tableBody = document.querySelector("table tbody");

        if (
          !addProductBtn ||
          !modal ||
          !closeModal ||
          !form ||
          !searchInput ||
          !categoryFilter ||
          !tableBody
        )
          return;

        function filterTable() {
          const searchTerm = searchInput.value.toLowerCase();
          const selectedCategory = categoryFilter.value;

          Array.from(tableBody.rows).forEach((row) => {
            const name = row.cells[1].textContent.toLowerCase();
            const category = row.cells[2].textContent;
            const matchesSearch = name.includes(searchTerm);
            const matchesCategory =
              selectedCategory === "" ||
              selectedCategory === "Filter by category" ||
              category === selectedCategory;
            row.style.display = matchesSearch && matchesCategory ? "" : "none";
          });
        }

        addProductBtn.addEventListener("click", () => {
          editingRow = null;
          editingId = null;
          form.reset();
          modal.style.display = "block";
        });

        closeModal.addEventListener(
          "click",
          () => (modal.style.display = "none")
        );

        window.addEventListener("click", (e) => {
          if (e.target === modal) modal.style.display = "none";
        });

        form.addEventListener("submit", function (e) {
          e.preventDefault();
          const data = {
            productID: form.elements["productID"].value.trim(),
            productName: form.elements["productName"].value.trim(),
            category: form.elements["category"].value.trim(),
            price: form.elements["price"].value.trim(),
            packaging: form.elements["packaging"].value.trim(),
            location: form.elements["location"].value.trim(),
            status: form.elements["status"].value,
            plantingDate: form.elements["plantingDate"].value,
            harvestDate: form.elements["harvestDate"].value,
            shelfLife: form.elements["shelfLife"].value.trim(), // Optimise Shelf Life
            storageTemp: form.elements["storageTemp"].value.trim(), // Optimise Storage Temp
            humidity: form.elements["humidity"].value.trim(), // Optimise Humidity
          };

          if (!data.productID || !data.productName) {
            alert("Please fill required fields.");
            return;
          }

          fetch(`product.php?action=save`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          })
            .then((res) => res.json())
            .then((response) => {
              alert(response.message);
              if (response.success) {
                if (editingRow) {
                  // Update existing row in table
                  const cells = editingRow.querySelectorAll("td");
                  cells[0].textContent = data.productID;
                  cells[1].textContent = data.productName;
                  cells[2].textContent = data.category;
                  cells[3].textContent = data.price;
                  cells[4].textContent = data.packaging;
                  cells[5].innerHTML =
                    data.status === "in-stock"
                      ? `<span style="background-color: #d4edda; color: #155724; padding: 4px 8px; border-radius: 15px; font-size: 12px;">In Stock</span>`
                      : `<span style="background-color: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 15px; font-size: 12px;">Stock Out</span>`;
                  cells[6].textContent = data.location;
                  cells[7].textContent = data.plantingDate;
                  cells[8].textContent = data.harvestDate;
                  cells[9].textContent = data.shelfLife; // Optimise Shelf Life
                  cells[10].textContent = data.storageTemp; // Optimise Storage Temp
                  cells[11].textContent = data.humidity; // Optimise Humidity
                } else {
                  // Add new row to table
                  const newRow = document.createElement("tr");
                  const statusLabel =
                    data.status === "in-stock"
                      ? `<span style="background-color: #d4edda; color: #155724; padding: 4px 8px; border-radius: 15px; font-size: 12px;">In Stock</span>`
                      : `<span style="background-color: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 15px; font-size: 12px;">Stock Out</span>`;
                  newRow.innerHTML = `
              <td>${data.productID}</td>
              <td>${data.productName}</td>
              <td>${data.category}</td>
              <td>${data.price}</td>
              <td>${data.packaging}</td>
              <td>${statusLabel}</td>
              <td>${data.location}</td>
              <td>${data.plantingDate}</td>
              <td>${data.harvestDate}</td>
              <td>${data.shelfLife}</td>
              <td>${data.storageTemp}</td>
              <td>${data.humidity}</td>
              <td>
                <button onclick="editProduct(this)" style="padding:4px 8px;background:#ffc107;color:white;border:none;border-radius:4px;">Edit</button>
                <button onclick="deleteProduct(this)" style="padding:4px 8px;background:#dc3545;color:white;border:none;border-radius:4px;">Delete</button>
              </td>
            `;
                  tableBody.appendChild(newRow);
                  updateCategoryDropdown(data.category);
                }

                modal.style.display = "none";
                form.reset();
                editingRow = null;
                editingId = null;
                filterTable();
              }
            })
            .catch((err) => {
              alert("Failed to save product");
              console.error(err);
            });
        });

        searchInput.addEventListener("input", filterTable);
        categoryFilter.addEventListener("change", filterTable);

        function updateCategoryDropdown(category) {
          const exists = Array.from(categoryFilter.options).some(
            (opt) => opt.value === category
          );
          if (!exists && category !== "") {
            const newOption = document.createElement("option");
            newOption.value = category;
            newOption.textContent = category;
            categoryFilter.appendChild(newOption);
          }
        }

        // Load products from backend on init
        function loadProducts() {
          fetch("product.php?action=list")
            .then((res) => res.json())
            .then((products) => {
              tableBody.innerHTML = "";
              products.forEach((p) => {
                const statusLabel =
                  p.status === "in-stock"
                    ? `<span style="background-color: #d4edda; color: #155724; padding: 4px 8px; border-radius: 15px; font-size: 12px;">In Stock</span>`
                    : `<span style="background-color: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 15px; font-size: 12px;">Stock Out</span>`;

                const row = document.createElement("tr");
                row.innerHTML = `
            <td>${p.productID}</td>
            <td>${p.productName}</td>
            <td>${p.category}</td>
            <td>${p.price}</td>
            <td>${p.packaging}</td>
            <td>${statusLabel}</td>
            <td>${p.location}</td>
            <td>${p.plantingDate}</td>
            <td>${p.harvestDate}</td>
            <td>${p.shelfLife}</td>
            <td>${p.storageTemp}</td>
            <td>${p.humidity}</td>
            <td>
              <button onclick="editProduct(this)" style="padding:4px 8px;background:#ffc107;color:white;border:none;border-radius:4px;">Edit</button>
              <button onclick="deleteProduct(this)" style="padding:4px 8px;background:#dc3545;color:white;border:none;border-radius:4px;">Delete</button>
            </td>
          `;
                tableBody.appendChild(row);
                updateCategoryDropdown(p.category);
              });
            })
            .catch((err) => {
              alert("Failed to load products");
              console.error(err);
            });
        }

        loadProducts();
      }

      // Initialize when DOM is ready
      window.addEventListener("DOMContentLoaded", () => {
        initProductPage();
      });

      // ---------- Inventory Page Logic ----------

      let invEditingRow = null;
      let invEditingId = null;

      // Load product and warehouse dropdowns
      function loadDropdowns() {
        const form = document.getElementById("inventoryForm");
        const productSelect = form.elements["product"];
        const warehouseSelect = form.elements["warehouse"];

        return Promise.all([
          fetch("inventory.php?products=1")
            .then((res) => res.json())
            .then((data) => {
              productSelect.innerHTML = `<option value="">Select Product</option>`;
              data.products.forEach((p) => {
                const option = document.createElement("option");
                option.value = p.productID;
                option.textContent = p.productName;
                productSelect.appendChild(option);
              });
            }),
          fetch("inventory.php?warehouses=1")
            .then((res) => res.json())
            .then((data) => {
              warehouseSelect.innerHTML = `<option value="">Select Warehouse</option>`;
              data.warehouses.forEach((w) => {
                const option = document.createElement("option");
                option.value = w.id;
                option.textContent = w.name;
                warehouseSelect.appendChild(option);
              });
            }),
        ]);
      }

      function editInventory(button) {
        const row = button.closest("tr");
        const cells = row.querySelectorAll("td");
        const modal = document.getElementById("inventoryModal");
        const form = document.getElementById("inventoryForm");

        if (!form || !modal) return;

        invEditingRow = row;
        invEditingId = row.dataset.id;

        loadDropdowns().then(() => {
          form.elements["product"].value = cells[1].dataset.id;
          form.elements["warehouse"].value = cells[3].dataset.id;
          form.elements["mainStorage"].value = parseFloat(
            cells[2].textContent.replace(" Kg", "")
          );
          form.elements["inWarehouse"].value = parseFloat(
            cells[4].textContent.replace(" Kg", "")
          ); // Packed
          form.elements["lastAvailable"].value = parseFloat(
            cells[5].textContent.replace(" Kg", "")
          ); // Unpacked
          modal.style.display = "block";
        });
      }

      function deleteInventory(button) {
        if (!confirm("Are you sure you want to delete this inventory record?"))
          return;

        const row = button.closest("tr");
        const id = row.dataset.id;

        fetch("inventory.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "delete", id }),
        })
          .then((res) => res.json())
          .then((data) => {
            alert(data.message);
            if (data.success) row.remove();
          })
          .catch((err) => {
            alert("Failed to delete inventory");
            console.error(err);
          });
      }

      function initInventoryPage() {
        const addBtn = document.getElementById("addInventoryBtn");
        const modal = document.getElementById("inventoryModal");
        const closeModal = document.getElementById("closeInventoryModal");
        const form = document.getElementById("inventoryForm");
        const searchInput = document.getElementById("inventorySearch");
        const tableBody = document.querySelector("#inventoryTable tbody");
        const cancelBtn = form.querySelector(".cancel-btn");

        if (
          !addBtn ||
          !modal ||
          !closeModal ||
          !form ||
          !searchInput ||
          !tableBody
        )
          return;

        // Open modal for new inventory
        addBtn.addEventListener("click", () => {
          invEditingRow = null;
          invEditingId = null;
          form.reset();
          loadDropdowns().then(() => (modal.style.display = "block"));
        });

        // Close modal
        closeModal.addEventListener(
          "click",
          () => (modal.style.display = "none")
        );
        cancelBtn.addEventListener(
          "click",
          () => (modal.style.display = "none")
        );
        window.addEventListener("click", (e) => {
          if (e.target === modal) modal.style.display = "none";
        });

        // Auto-calculate Unpacked (previously Last Available)
        function calculateUnpacked() {
          const main = parseFloat(form.elements["mainStorage"].value) || 0;
          const packed = parseFloat(form.elements["inWarehouse"].value) || 0; // Previously In Warehouse
          form.elements["lastAvailable"].value = (main - packed).toFixed(2);
        }

        form.elements["mainStorage"].addEventListener(
          "input",
          calculateUnpacked
        );
        form.elements["inWarehouse"].addEventListener(
          "input",
          calculateUnpacked
        );

        // Submit add/edit form
        form.addEventListener("submit", (e) => {
          e.preventDefault();

          const data = {
            action: "save",
            id: invEditingId,
            product_id: form.elements["product"].value,
            warehouse_id: form.elements["warehouse"].value,
            main_storage: parseFloat(form.elements["mainStorage"].value),
            in_warehouse: parseFloat(form.elements["inWarehouse"].value), // Packed
            last_available: parseFloat(form.elements["lastAvailable"].value), // Unpacked
          };

          if (!data.product_id || !data.warehouse_id) {
            alert("Please select product and warehouse");
            return;
          }

          fetch("inventory.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          })
            .then((res) => res.json())
            .then((resp) => {
              alert(resp.message);
              if (resp.success) {
                loadInventory();
                modal.style.display = "none";
                form.reset();
                invEditingRow = null;
                invEditingId = null;
              }
            })
            .catch((err) => {
              alert("Failed to save inventory");
              console.error(err);
            });
        });

        // Search filter
        searchInput.addEventListener("input", () => {
          const term = searchInput.value.toLowerCase();
          Array.from(tableBody.rows).forEach((row) => {
            row.style.display = row.innerText.toLowerCase().includes(term)
              ? ""
              : "none";
          });
        });

        // Load inventory table
        function loadInventory() {
          fetch("inventory.php")
            .then((res) => res.json())
            .then((data) => {
              tableBody.innerHTML = "";
              data.inventory.forEach((i) => {
                const row = document.createElement("tr");
                row.dataset.id = i.id;
                row.innerHTML = `
            <td>${i.id}</td> <!-- Batch ID -->
            <td data-id="${i.product_id}">${i.productName}</td>
            <td>${i.main_storage} Kg</td>
            <td data-id="${i.warehouse_id}">${i.warehouseName}</td>
            <td>${i.in_warehouse} Kg</td> <!-- Packed -->
            <td>${i.last_available} Kg</td> <!-- Unpacked -->
            <td>
              <button onclick="editInventory(this)" style="padding:4px 8px;background:#ffc107;color:white;border:none;border-radius:4px;">Edit</button>
              <button onclick="deleteInventory(this)" style="padding:4px 8px;background:#dc3545;color:white;border:none;border-radius:4px;">Delete</button>
            </td>
          `;
                tableBody.appendChild(row);
              });
            })
            .catch((err) => console.error("Failed to load inventory", err));
        }

        loadInventory();
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", initInventoryPage);

      //---documents page logic---
      function initDocumentPage() {
        const modal = document.getElementById("uploadModal");
        const form = document.getElementById("uploadForm");
        const tableBody = document.getElementById("documentBody");
        const typeFilter = document.getElementById("typeFilter");
        const statusFilter = document.getElementById("statusFilter");
        const searchInput = document.getElementById("searchInput");

        const totalDocEl = document.getElementById("total-documents");
        const pendingReviewEl = document.getElementById("pending-documents");
        const complianceRateEl = document.getElementById("compliance-rate");
        const expiringSoonEl = document.getElementById("expiring-documents");

        const uploadBtn = document.getElementById("uploadDocumentBtn");
        const closeBtn = document.getElementById("closeUploadModal");

        let documents = [];

        // Open modal
        uploadBtn.onclick = () => {
          modal.style.display = "block";
          form.reset();
        };

        // Close modal
        closeBtn.onclick = () => {
          modal.style.display = "none";
          form.reset();
        };
        window.onclick = (e) => {
          if (e.target === modal) {
            modal.style.display = "none";
            form.reset();
          }
        };

        // Load documents from backend
        function loadDocuments() {
          fetch("documents.php")
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                documents = data.documents.map((doc) => ({
                  ...doc,
                  typeLower: doc.type.toLowerCase(),
                  statusLower: doc.status.toLowerCase(),
                }));
                renderDocuments();
                updateStats(data.stats);
              } else {
                alert("Failed to load documents");
              }
            })
            .catch(() => alert("Error loading documents"));
        }

        // Submit form to backend
        form.onsubmit = (e) => {
          e.preventDefault();

          const fileInput = form.pdfFile;
          if (!fileInput.files.length) {
            alert("Please select a PDF file.");
            return;
          }

          const file = fileInput.files[0];
          if (file.type !== "application/pdf") {
            alert("Only PDF files are allowed.");
            return;
          }

          const formData = new FormData(form);
          formData.append("fileSize", (file.size / 1024).toFixed(2)); // KB

          fetch("documents.php", {
            method: "POST",
            body: formData,
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                documents = data.documents.map((doc) => ({
                  ...doc,
                  typeLower: doc.type.toLowerCase(),
                  statusLower: doc.status.toLowerCase(),
                }));
                renderDocuments();
                updateStats(data.stats);
                modal.style.display = "none";
                form.reset();
              } else {
                alert(data.message || "Failed to save document");
              }
            })
            .catch(() => alert("Error saving document"));
        };

        // Render documents with filters & search
        function renderDocuments() {
          const search = searchInput.value.toLowerCase();
          const filterType = typeFilter.value.toLowerCase();
          const filterStatus = statusFilter.value.toLowerCase();

          tableBody.innerHTML = "";

          documents.forEach((doc, index) => {
            const matchesSearch =
              doc.typeLower.includes(search) ||
              doc.number.toLowerCase().includes(search) ||
              doc.shipmentId.toLowerCase().includes(search) ||
              doc.productName.toLowerCase().includes(search) ||
              doc.distribution.toLowerCase().includes(search);

            const matchesType = !filterType || doc.typeLower === filterType;
            const matchesStatus =
              !filterStatus || doc.statusLower === filterStatus;

            if (matchesSearch && matchesType && matchesStatus) {
              const issueDateFormatted = new Date(
                doc.issueDate
              ).toLocaleDateString();
              const expiryDateFormatted = new Date(
                doc.expiryDate
              ).toLocaleDateString();

              const tr = document.createElement("tr");
              tr.innerHTML = `
          <td><strong>${doc.type}</strong><br>${doc.number}</td>
          <td>${doc.shipmentId}<br>${doc.productName}<br>${
                doc.distribution
              }</td>
          <td>Issued: ${issueDateFormatted}<br>Expires: ${expiryDateFormatted}</td>
          <td><span class="badge ${doc.statusLower.replace(/ /g, "-")}">${
                doc.status
              }</span></td>
          <td><span class="badge ${doc.compliance.toLowerCase()}">${
                doc.compliance
              }</span></td>
          <td>${doc.fileSize} KB</td>
          <td>
            <button class="view-btn" onclick="alert('Preview not implemented')">👁️ View</button>
            <button class="download-btn" onclick="downloadPDF(${index})">⬇️ Download</button>
            <button class="review-btn">✔️ Mark Reviewed</button>
          </td>
        `;

              // Review button handler with backend update
              tr.querySelector(".review-btn").onclick = () => {
                if (doc.status !== "Reviewed") {
                  // Send POST to update status in backend
                  const formData = new FormData();
                  formData.append("action", "markReviewed");
                  formData.append("id", doc.id);

                  fetch("documents.php", {
                    method: "POST",
                    body: formData,
                  })
                    .then((res) => res.json())
                    .then((data) => {
                      if (data.success) {
                        // Update local doc status & compliance
                        doc.status = "Reviewed";
                        doc.statusLower = "reviewed";
                        doc.compliance = "Yes";

                        renderDocuments();
                        updateStats(data.stats);
                      } else {
                        alert(data.message || "Failed to update status");
                      }
                    })
                    .catch(() => alert("Error updating document status"));
                }
              };

              tableBody.appendChild(tr);
            }
          });
        }

        // Update stats cards
        function updateStats(stats) {
          totalDocEl.textContent = stats.total;
          pendingReviewEl.textContent = stats.pending;
          complianceRateEl.textContent = stats.complianceRate + "%";
          expiringSoonEl.textContent = stats.expiringSoon;
        }

        // Download PDF (placeholder)
        function downloadPDF(index) {
          alert("Download from backend not implemented yet.");
        }

        window.downloadPDF = downloadPDF; // Expose globally for inline onclick

        // Filters and search event listeners
        [searchInput, typeFilter, statusFilter].forEach((el) =>
          el.addEventListener("input", renderDocuments)
        );

        // Initial load
        loadDocuments();
      }

      // ---------- Warehouse Page Logic ----------
      function initWarehousePage() {
        const modal = document.getElementById("addWarehouseModal");
        const openBtn = document.getElementById("addWarehouseBtn");
        const closeBtn = document.getElementById("closeWarehouseModal");
        const form = document.getElementById("warehouseForm");
        const searchInput = document.getElementById("searchWarehouse");
        const tableBody = document.getElementById("warehouseTableBody");

        function loadWarehouses() {
          fetch("warehouse.php")
            .then((res) => res.json())
            .then((data) => {
              tableBody.innerHTML = "";
              let totalCapacity = 0;

              data.forEach((wh) => {
                // Ensure capacity is a valid number
                let capacityNum = parseInt(wh.capacity);
                if (isNaN(capacityNum)) capacityNum = 0;
                totalCapacity += capacityNum;

                const row = `<tr>
            <td>${wh.name}</td>
            <td>${wh.location}</td>
            <td>${capacityNum} kg</td>
            <td>${wh.manager}</td>
            <td>${wh.type}</td>
          </tr>`;
                tableBody.innerHTML += row;
              });

              document.getElementById("totalWarehouses").textContent =
                data.length;
              document.getElementById("totalCapacity").textContent =
                totalCapacity + " kg";

              // For example, occupied space is 60% of total capacity (you can adjust this logic)
              const occupiedSpace = Math.floor(totalCapacity * 0.6);
              document.getElementById("occupiedSpace").textContent =
                occupiedSpace + " kg";
            });
        }

        openBtn.onclick = () => (modal.style.display = "block");
        closeBtn.onclick = () => (modal.style.display = "none");
        window.onclick = (e) => {
          if (e.target == modal) modal.style.display = "none";
        };

        form.addEventListener("submit", function (e) {
          e.preventDefault();
          const formData = new FormData(form);
          fetch("warehouse.php", {
            method: "POST",
            body: formData,
          })
            .then((res) => res.json())
            .then((response) => {
              if (response.success) {
                modal.style.display = "none";
                form.reset();
                loadWarehouses();
              } else {
                alert(response.error || "Failed to add warehouse");
              }
            });
        });

        searchInput.addEventListener("keyup", function () {
          const filter = searchInput.value.toLowerCase();
          const rows = tableBody.getElementsByTagName("tr");
          for (let i = 0; i < rows.length; i++) {
            const text = rows[i].textContent.toLowerCase();
            rows[i].style.display = text.includes(filter) ? "" : "none";
          }
        });

        loadWarehouses();
      }

      // ---------- Consumer Page Logic ----------
      function initConsumerPage() {
        const addBtn = document.querySelector(".add-consumer-btn");
        const modal = document.getElementById("addConsumerModal");
        const form = document.getElementById("consumerForm");
        const tbody = document.getElementById("consumerTableBody");
        const searchInput = document.getElementById("searchConsumer");
        const typeFilter = document.getElementById("filterType");
        const statusFilter = document.getElementById("filterStatus");

        const countCards = {
          farmer: document.getElementById("totalFarmers"),
          supplier: document.getElementById("totalSuppliers"),
          customer: document.getElementById("totalCustomers"),
          newThisMonth: document.getElementById("newThisMonth"),
        };

        if (
          !addBtn ||
          !modal ||
          !form ||
          !tbody ||
          !searchInput ||
          !typeFilter ||
          !statusFilter
        ) {
          console.warn("Consumer page elements missing");
          return;
        }

        let consumers = [];

        function loadConsumers() {
          fetch("consumers.php")
            .then((res) => {
              if (!res.ok) throw new Error("Network response was not ok");
              return res.json();
            })
            .then((data) => {
              if (data.consumers && Array.isArray(data.consumers)) {
                consumers = data.consumers.map((c) => ({
                  name: c.name || "",
                  type: (c.type || "").toLowerCase(),
                  email: c.email || "",
                  phone: c.phone || "",
                  location: c.location || "",
                  status: (c.status || "").toLowerCase(),
                }));
                updateTable();
                updateCards(data.counts);
              } else {
                console.error("Invalid data format from consumers.php", data);
                alert("Failed to load consumers data.");
              }
            })
            .catch((err) => {
              console.error("Error loading consumers content:", err);
              alert("Error loading consumers content.");
            });
        }

        addBtn.onclick = () => {
          modal.style.display = "flex";
        };

        modal.querySelector(".close-btn").onclick = () => {
          modal.style.display = "none";
          form.reset();
        };

        form.onsubmit = function (e) {
          e.preventDefault();

          const name = document.getElementById("consumerName").value.trim();
          const type = document
            .getElementById("consumerType")
            .value.toLowerCase();
          const email = document.getElementById("consumerEmail").value.trim();
          const phone = document.getElementById("consumerPhone").value.trim();
          const status = document
            .getElementById("consumerStatus")
            .value.toLowerCase();
          const location = document.getElementById("location").value.trim();

          if (!name || !type) {
            alert("Please fill in required fields.");
            return;
          }

          const formData = new FormData();
          formData.append("name", name);
          formData.append("type", type);
          formData.append("email", email);
          formData.append("phone", phone);
          formData.append("location", location);
          formData.append("status", status);

          fetch("consumers.php", {
            method: "POST",
            body: formData,
          })
            .then((res) => {
              if (!res.ok) throw new Error("Failed to submit form");
              return res.json();
            })
            .then((data) => {
              if (data.success) {
                consumers = data.consumers.map((c) => ({
                  name: c.name,
                  type: c.type,
                  email: c.email,
                  phone: c.phone,
                  location: c.location,
                  status: c.status,
                }));
                updateTable();
                updateCards(data.counts);
                modal.style.display = "none";
                form.reset();
              } else {
                alert(data.message || "Failed to add consumer");
              }
            })
            .catch((err) => {
              alert("Error: " + err.message);
            });
        };

        searchInput.addEventListener("input", updateTable);
        typeFilter.addEventListener("change", updateTable);
        statusFilter.addEventListener("change", updateTable);

        function updateTable() {
          tbody.innerHTML = "";

          const search = searchInput.value.toLowerCase();
          const filterType = typeFilter.value.toLowerCase();
          const filterStatus = statusFilter.value.toLowerCase();

          consumers.forEach((c) => {
            const matchesSearch =
              c.name.toLowerCase().includes(search) ||
              c.email.toLowerCase().includes(search) ||
              c.phone.toLowerCase().includes(search) ||
              c.location.toLowerCase().includes(search);

            const matchesType = !filterType || c.type === filterType;
            const matchesStatus = !filterStatus || c.status === filterStatus;

            if (matchesSearch && matchesType && matchesStatus) {
              const tr = document.createElement("tr");
              tr.innerHTML = `
          <td>${c.name}</td>
          <td><span class="type-tag ${c.type}">${capitalize(c.type)}</span></td>
          <td>${c.location}</td>
          <td>📧 ${c.email}<br>📞 ${c.phone}</td>
          <td><span class="status-tag ${c.status}">${capitalize(
                c.status
              )}</span></td>
        `;
              tbody.appendChild(tr);
            }
          });
        }

        function updateCards(countsFromPHP) {
          if (countsFromPHP) {
            countCards.farmer.textContent = countsFromPHP.farmers || 0;
            countCards.supplier.textContent = countsFromPHP.suppliers || 0;
            countCards.customer.textContent = countsFromPHP.customers || 0;
            countCards.newThisMonth.textContent =
              countsFromPHP.newThisMonth || 0;
          } else {
            countCards.farmer.textContent = consumers.filter(
              (c) => c.type === "farmer"
            ).length;
            countCards.supplier.textContent = consumers.filter(
              (c) => c.type === "supplier"
            ).length;
            countCards.customer.textContent = consumers.filter(
              (c) => c.type === "customer"
            ).length;
            countCards.newThisMonth.textContent = consumers.length;
          }
        }

        function capitalize(str) {
          if (!str) return "";
          return str.charAt(0).toUpperCase() + str.slice(1);
        }

        loadConsumers();
      }

      loadContent("home");
    </script>
  </body>
</html>
