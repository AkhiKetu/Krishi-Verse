<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Krishi-Verse</title>
    <link rel="stylesheet" href="dashboard.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <script
      src="https://kit.fontawesome.com/a076d05399.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js CDN -->
    <script>
      if (localStorage.getItem("loggedIn") !== "true") {
        window.location.href = "login.html";
      }
    </script>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <h2 class="logo">Krishi-Verse</h2>
        <div class="user">
          <img src="panda.jpeg" alt="User" />
          <p id="displayUsername">
            Loading...<br /><span id="displayRole">Role</span>
          </p>
        </div>
        <nav>
          <ul>
            <li>
              <a href="#" data-page="home"><i class="fas fa-home"></i> Home</a>
            </li>
            <li>
              <a href="#" data-page="product"
                ><i class="fas fa-box"></i> Products</a
              >
            </li>
            <li>
              <a href="#" data-page="warehouse"
                ><i class="fas fa-warehouse"></i> Warehouse</a
              >
            </li>
            <li>
              <a href="#" data-page="documents"
                ><i class="fas fa-file-alt"></i> Documents</a
              >
            </li>
            <li>
              <a href="#" data-page="consumers"
                ><i class="fas fa-users"></i> Consumers</a
              >
            </li>
            <li>
              <a href="#" data-page="transportation"
                ><i class="fas fa-tools"></i> Transportation</a
              >
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <div class="main">
        <header>
          <div class="header-right">
            <a href="#" class="notification-btn">Notification</a>
            <a href="#" class="message-btn">Message</a>
            <div class="profile-dropdown">
              <a href="#" class="profile-btn" onclick="toggleDropdown(event)"
                >Profile <i class="fas fa-caret-down"></i
              ></a>
              <div id="dropdown-menu" class="dropdown-content">
                <a href="#">Edit Profile</a>
                <a href="#">Settings</a>
              </div>
            </div>
            <a href="#" onclick="logout()" class="logout-btn">Logout</a>
          </div>
        </header>

        <section class="content">
          <!-- Content will be dynamically loaded here -->
        </section>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const username = localStorage.getItem("username") || "User";
        const role = localStorage.getItem("designation") || "warehouseManager";

        // Update DOM elements with the stored values
        document.getElementById(
          "displayUsername"
        ).innerHTML = `${username}<br><span>${formatRole(role)}</span>`;
      });

      function formatRole(role) {
        switch (role) {
          case "warehouseManager":
            return "Warehouse-Manager";
          case "supplier":
            return "Supplier";
          case "transporter":
            return "Transporter";
          case "distributor":
            return "Distributor";
          case "retailer":
            return "Retailer";
          default:
            return role;
        }
      }

      // Redirect if not logged in
      function logout() {
        localStorage.removeItem("loggedIn");
        window.location.href = "index.html";
      }

      function toggleDropdown(e) {
        e.preventDefault();
        const menu = document.getElementById("dropdown-menu");
        menu.classList.toggle("show");
      }

      window.addEventListener("click", function (e) {
        if (!e.target.closest(".profile-dropdown")) {
          document.getElementById("dropdown-menu").classList.remove("show");
        }
      });

      const links = document.querySelectorAll("nav a");
      const contentArea = document.querySelector(".content");

      links.forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          const page = this.getAttribute("data-page");
          loadContent(page);
        });
      });

      function loadContent(page) {
        fetch(`${page}.html?v=${new Date().getTime()}`)
          .then((res) => res.text())
          .then((data) => {
            contentArea.innerHTML = data;

            if (page === "product") initProductPage();
            if (page === "warehouse") initWarehousePage();
            if (page === "consumers") initConsumerPage();
            if (page === "home") loadHomeChart();
            if (page === "transportation") initTransportationPage();
            if (page === "documents") initDocumentPage();
          })
          .catch((err) => {
            contentArea.innerHTML = `<p>Error loading ${page} content.</p>`;
          });
      }

      function loadHomeChart() {
        fetch("product.php?action=list")
          .then((res) => res.json())
          .then((products) => {
            const productNames = [];
            const productPrices = [];

            products.forEach((product) => {
              const name = product.productName;
              const price = parseFloat(product.price);

              if (name && !isNaN(price)) {
                productNames.push(name);
                productPrices.push(price);
              }
            });

            const ctx = document
              .getElementById("productChart")
              ?.getContext("2d");
            if (ctx) {
              new Chart(ctx, {
                type: "bar",
                data: {
                  labels: productNames,
                  datasets: [
                    {
                      label: "Price (Bdt/kg)",
                      data: productPrices,
                      backgroundColor: [
                        "#5B5EA6",
                        "#76B947",
                        "#E94B3C",
                        "#007F5C",
                        "#FFD700",
                        "#FF6F61",
                        "#6B5B95",
                      ],
                      borderRadius: 8,
                    },
                  ],
                },
                options: {
                  responsive: true,
                  scales: {
                    y: {
                      beginAtZero: true,
                      title: {
                        display: true,
                        text: "Price (Bdt/kg)",
                      },
                    },
                  },
                  plugins: {
                    title: {
                      display: true,
                      text: "Products Vs Price Index",
                    },
                    legend: {
                      display: false,
                    },
                  },
                },
              });
            }
          })
          .catch((error) => {
            console.error("Error loading product data for chart:", error);
          });
      }

      // Call the function once the page loads
      window.addEventListener("DOMContentLoaded", loadHomeChart);

      // ---------- Transportation Page Logic ----------

      function initTransportationPage() {
        const modal = document.getElementById("scheduleModal");
        const scheduleBtn = document.querySelector(".schedule-btn");
        const form = document.querySelector(".schedule-form");
        const tableBody = document.querySelector(".transport-table tbody");

        const summaryActiveRoutes = document.querySelector(
          ".summary-cards .card:nth-child(1) .value"
        );
        const summaryScheduledToday = document.querySelector(
          ".summary-cards .card:nth-child(1) .sub"
        );
        const availableVehiclesCount = document.querySelector(
          ".summary-cards .card:nth-child(2) .value"
        );

        const vehicleList = ["RT-001", "RT-002", "DC-003", "DC-004"];

        if (!modal || !scheduleBtn || !form || !tableBody) {
          console.warn("Transportation page elements not found.");
          return;
        }

        // Open modal to add new transport
        scheduleBtn.onclick = () => {
          form.reset();
          modal.style.display = "block";
          form.setAttribute("data-editing", "false");
          form.editingRow = null;
        };

        // Close modal if clicked outside content
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.style.display = "none";
          }
        });

        // Close modal on (x) click
        modal.querySelector(".close").onclick = () => {
          modal.style.display = "none";
        };

        // Close modal on cancel button
        form.querySelector(".cancel-btn").onclick = () => {
          modal.style.display = "none";
        };

        // Handle form submit (Add/Edit)
        form.onsubmit = function (e) {
          e.preventDefault();

          const editing = form.getAttribute("data-editing") === "true";
          const editingRow = form.editingRow;

          const origin = form.origin.value.trim();
          const destination = form.destination.value.trim();
          const product = form.product.value;
          const weight = form.weight.value.trim();
          const vehicle = form.vehicle.value;
          const driver = form.driver.value;
          const date = form.date.value;
          const time = form.time.value;
          const priority = form.priority.value;
          const temperature = form.temperature.value;
          const humidity = form.humidity.value;
          const distanceKm = parseFloat(form.distance.value) || 0;

          if (
            !origin ||
            !destination ||
            !product ||
            !weight ||
            !vehicle ||
            !driver ||
            !date ||
            !time ||
            !priority ||
            !temperature ||
            !humidity
          ) {
            alert("Please fill in all required fields.");
            return;
          }

          const routeId =
            editing && editingRow
              ? editingRow.dataset.id
              : "TRP-" + Math.floor(Math.random() * 900 + 100);

          const routeText = `${origin} → ${destination}<br><small>${product} (${weight})</small>`;
          const vehicleDriver = `🚛 ${vehicle}<br>👤 ${driver}`;
          const scheduleText = `${date}<br>${time}`;
          const distance = `${distanceKm} km<br><small>ETA: ${Math.floor(
            Math.random() * 3 + 1
          )} hrs</small>`;
          const priorityTag = `<span class="priority ${priority.toLowerCase()}">${priority}</span>`;
          const statusTag = `<span class="status scheduled">Scheduled</span>`;
          const cost = `${(distanceKm * 15).toFixed(2)} BDT`;

          const rowHTML = `
      <td>${routeId}</td>
      <td>${routeText}</td>
      <td>${vehicleDriver}</td>
      <td>${scheduleText}</td>
      <td>${distance}</td>
      <td>${priorityTag}</td>
      <td>${statusTag}</td>
      <td>${cost}</td>
      <td>${temperature}</td>
      <td>${humidity}</td>
      <td>
        <button class="edit-btn">Edit</button>
        <button class="delete-btn">Delete</button>
      </td>
    `;

          if (editing && editingRow) {
            editingRow.innerHTML = rowHTML;
            editingRow.dataset.id = routeId;
          } else {
            const newRow = document.createElement("tr");
            newRow.innerHTML = rowHTML;
            newRow.dataset.id = routeId;
            tableBody.appendChild(newRow);
          }

          modal.style.display = "none";
          form.reset();
          updateSummaryCards();
          updateFleetStatus();
          bindEditDeleteButtons();
        };

        // Bind Edit and Delete buttons on all rows
        function bindEditDeleteButtons() {
          tableBody.querySelectorAll(".edit-btn").forEach((btn) => {
            btn.onclick = (e) => {
              const row = e.target.closest("tr");
              const cells = row.querySelectorAll("td");

              const html = cells[1].innerHTML;
              const [routePart, productPart] = html.split("<br><small>");
              const [originText, destinationText] = routePart
                .split("→")
                .map((s) => s.trim());
              const productName = productPart
                .replace(")</small>", "")
                .split("(")[0]
                .trim();
              const weight = productPart.match(/\(([^)]+)\)/)[1];

              form.setAttribute("data-editing", "true");
              form.editingRow = row;

              form.origin.value = originText;
              form.destination.value = destinationText;
              form.product.value = productName;
              form.weight.value = weight;
              form.vehicle.value = cells[2].innerText
                .split("\n")[0]
                .replace("🚛 ", "")
                .trim();
              form.driver.value = cells[2].innerText
                .split("\n")[1]
                .replace("👤 ", "")
                .trim();
              form.date.value = cells[3].innerText.split("\n")[0];
              form.time.value = cells[3].innerText.split("\n")[1];
              form.priority.value = cells[5].innerText.trim();
              form.distance.value = parseFloat(cells[4].innerText) || "";
              form.temperature.value = cells[8].innerText;
              form.humidity.value = cells[9].innerText;

              modal.style.display = "block";
            };
          });

          tableBody.querySelectorAll(".delete-btn").forEach((btn) => {
            btn.onclick = (e) => {
              if (confirm("Are you sure you want to delete this route?")) {
                e.target.closest("tr").remove();
                updateSummaryCards();
                updateFleetStatus();
              }
            };
          });
        }

        // Update summary cards info
        function updateSummaryCards() {
          const rows = tableBody.querySelectorAll("tr");
          const today = new Date().toISOString().split("T")[0];
          let scheduledToday = 0;

          rows.forEach((row) => {
            const scheduleDate = row.cells[3].innerText.split("\n")[0];
            if (scheduleDate === today) scheduledToday++;
          });

          summaryActiveRoutes.textContent = rows.length;
          summaryScheduledToday.textContent = `${scheduledToday} scheduled for today`;
        }

        // Update available vehicles count
        function updateFleetStatus() {
          const usedVehicles = Array.from(tableBody.querySelectorAll("tr")).map(
            (row) =>
              row.cells[2].innerText.split("\n")[0].replace("🚛 ", "").trim()
          );
          const available = vehicleList.filter(
            (v) => !usedVehicles.includes(v)
          );
          availableVehiclesCount.textContent = available.length;
        }

        // Initial setup
        updateSummaryCards();
        updateFleetStatus();
        bindEditDeleteButtons();
      }

      // Initialize after DOM loads
      document.addEventListener("DOMContentLoaded", () => {
        initTransportationPage();
      });

      // ---------- Product Page Logic ----------

      let editingRow = null;
      let editingId = null; // track productID when editing

      function editProduct(button) {
        const row = button.closest("tr");
        const cells = row.querySelectorAll("td");
        const modal = document.getElementById("addProductModal");
        const form = document.getElementById("addProductForm");

        if (!form || !modal) return;

        editingRow = row;
        editingId = cells[0].textContent;

        form.elements["productID"].value = cells[0].textContent;
        form.elements["productName"].value = cells[1].textContent;
        form.elements["category"].value = cells[2].textContent;
        form.elements["price"].value = cells[3].textContent;
        form.elements["packaging"].value = cells[4].textContent;
        form.elements["location"].value = cells[6].textContent;

        const statusSpan = cells[5].querySelector("span");
        form.elements["status"].value =
          statusSpan && statusSpan.textContent.includes("In Stock")
            ? "in-stock"
            : "stock-out";

        form.elements["plantingDate"].value = cells[7].textContent;
        form.elements["harvestDate"].value = cells[8].textContent;
        form.elements["shelfLife"].value = cells[9].textContent;
        form.elements["storageTemp"].value = cells[10].textContent;
        form.elements["humidity"].value = cells[11].textContent;

        modal.style.display = "block";
      }

      function deleteProduct(button) {
        if (!confirm("Are you sure you want to delete this product?")) return;

        const row = button.closest("tr");
        const productID = row.cells[0].textContent;

        fetch(`product.php?action=delete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productID }),
        })
          .then((res) => res.json())
          .then((response) => {
            alert(response.message);
            if (response.success) {
              row.remove();
            }
          })
          .catch((err) => {
            alert("Failed to delete product");
            console.error(err);
          });
      }

      function initProductPage() {
        const addProductBtn = document.getElementById("addProductBtn");
        const modal = document.getElementById("addProductModal");
        const closeModal = document.getElementById("closeModal");
        const form = document.getElementById("addProductForm");
        const searchInput = document.getElementById("searchInput");
        const categoryFilter = document.getElementById("categoryFilter");
        const tableBody = document.querySelector("table tbody");

        if (
          !addProductBtn ||
          !modal ||
          !closeModal ||
          !form ||
          !searchInput ||
          !categoryFilter ||
          !tableBody
        )
          return;

        function filterTable() {
          const searchTerm = searchInput.value.toLowerCase();
          const selectedCategory = categoryFilter.value;

          Array.from(tableBody.rows).forEach((row) => {
            const name = row.cells[1].textContent.toLowerCase();
            const category = row.cells[2].textContent;
            const matchesSearch = name.includes(searchTerm);
            const matchesCategory =
              selectedCategory === "" ||
              selectedCategory === "Filter by category" ||
              category === selectedCategory;
            row.style.display = matchesSearch && matchesCategory ? "" : "none";
          });
        }

        addProductBtn.addEventListener("click", () => {
          editingRow = null;
          editingId = null;
          form.reset();
          modal.style.display = "block";
        });

        closeModal.addEventListener(
          "click",
          () => (modal.style.display = "none")
        );

        window.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.style.display = "none";
          }
        });

        form.addEventListener("submit", function (e) {
          e.preventDefault();
          const data = {
            productID: form.elements["productID"].value.trim(),
            productName: form.elements["productName"].value.trim(),
            category: form.elements["category"].value.trim(),
            price: form.elements["price"].value.trim(),
            packaging: form.elements["packaging"].value.trim(),
            location: form.elements["location"].value.trim(),
            status: form.elements["status"].value,
            plantingDate: form.elements["plantingDate"].value,
            harvestDate: form.elements["harvestDate"].value,
            shelfLife: form.elements["shelfLife"].value.trim(),
            storageTemp: form.elements["storageTemp"].value.trim(),
            humidity: form.elements["humidity"].value.trim(),
          };

          if (!data.productID || !data.productName) {
            alert("Please fill required fields.");
            return;
          }

          fetch(`product.php?action=save`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          })
            .then((res) => res.json())
            .then((response) => {
              alert(response.message);
              if (response.success) {
                if (editingRow) {
                  // Update existing row in table
                  const cells = editingRow.querySelectorAll("td");
                  cells[0].textContent = data.productID;
                  cells[1].textContent = data.productName;
                  cells[2].textContent = data.category;
                  cells[3].textContent = data.price;
                  cells[4].textContent = data.packaging;
                  cells[5].innerHTML =
                    data.status === "in-stock"
                      ? `<span style="background-color: #d4edda; color: #155724; padding: 4px 8px; border-radius: 15px; font-size: 12px;">In Stock</span>`
                      : `<span style="background-color: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 15px; font-size: 12px;">Stock Out</span>`;
                  cells[6].textContent = data.location;
                  cells[7].textContent = data.plantingDate;
                  cells[8].textContent = data.harvestDate;
                  cells[9].textContent = data.shelfLife;
                  cells[10].textContent = data.storageTemp;
                  cells[11].textContent = data.humidity;
                } else {
                  // Add new row to table
                  const newRow = document.createElement("tr");
                  const statusLabel =
                    data.status === "in-stock"
                      ? `<span style="background-color: #d4edda; color: #155724; padding: 4px 8px; border-radius: 15px; font-size: 12px;">In Stock</span>`
                      : `<span style="background-color: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 15px; font-size: 12px;">Stock Out</span>`;
                  newRow.innerHTML = `
            <td>${data.productID}</td>
            <td>${data.productName}</td>
            <td>${data.category}</td>
            <td>${data.price}</td>
            <td>${data.packaging}</td>
            <td>${statusLabel}</td>
            <td>${data.location}</td>
            <td>${data.plantingDate}</td>
            <td>${data.harvestDate}</td>
            <td>${data.shelfLife}</td>
            <td>${data.storageTemp}</td>
            <td>${data.humidity}</td>
            <td>
              <button onclick="editProduct(this)" style="padding:4px 8px;background:#ffc107;color:white;border:none;border-radius:4px;">Edit</button>
              <button onclick="deleteProduct(this)" style="padding:4px 8px;background:#dc3545;color:white;border:none;border-radius:4px;">Delete</button>
            </td>
          `;
                  tableBody.appendChild(newRow);
                  updateCategoryDropdown(data.category);
                }

                modal.style.display = "none";
                form.reset();
                editingRow = null;
                editingId = null;
                filterTable();
              }
            })
            .catch((err) => {
              alert("Failed to save product");
              console.error(err);
            });
        });

        searchInput.addEventListener("input", filterTable);
        categoryFilter.addEventListener("change", filterTable);

        function updateCategoryDropdown(category) {
          const exists = Array.from(categoryFilter.options).some(
            (opt) => opt.value === category
          );
          if (!exists && category !== "") {
            const newOption = document.createElement("option");
            newOption.value = category;
            newOption.textContent = category;
            categoryFilter.appendChild(newOption);
          }
        }

        // Load products from backend on init
        function loadProducts() {
          fetch("product.php?action=list")
            .then((res) => res.json())
            .then((products) => {
              tableBody.innerHTML = "";
              products.forEach((p) => {
                const statusLabel =
                  p.status === "in-stock"
                    ? `<span style="background-color: #d4edda; color: #155724; padding: 4px 8px; border-radius: 15px; font-size: 12px;">In Stock</span>`
                    : `<span style="background-color: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 15px; font-size: 12px;">Stock Out</span>`;

                const row = document.createElement("tr");
                row.innerHTML = `
            <td>${p.productID}</td>
            <td>${p.productName}</td>
            <td>${p.category}</td>
            <td>${p.price}</td>
            <td>${p.packaging}</td>
            <td>${statusLabel}</td>
            <td>${p.location}</td>
            <td>${p.plantingDate}</td>
            <td>${p.harvestDate}</td>
            <td>${p.shelfLife}</td>
            <td>${p.storageTemp}</td>
            <td>${p.humidity}</td>
            <td>
              <button onclick="editProduct(this)" style="padding:4px 8px;background:#ffc107;color:white;border:none;border-radius:4px;">Edit</button>
              <button onclick="deleteProduct(this)" style="padding:4px 8px;background:#dc3545;color:white;border:none;border-radius:4px;">Delete</button>
            </td>
          `;
                tableBody.appendChild(row);
                updateCategoryDropdown(p.category);
              });
            })
            .catch((err) => {
              alert("Failed to load products");
              console.error(err);
            });
        }

        loadProducts();
      }

      // Initialize when DOM is ready
      window.addEventListener("DOMContentLoaded", () => {
        initProductPage();
      });

      //---documents page logic---
      function initDocumentPage() {
        const modal = document.getElementById("uploadModal");
        const form = document.getElementById("uploadForm");
        const tableBody = document.querySelector(".document-table tbody");
        const typeFilter = document.getElementById("typeFilter");
        const statusFilter = document.getElementById("statusFilter");
        const searchInput = document.getElementById("searchInput");

        const totalDocEl = document.getElementById("total-documents");
        const pendingReviewEl = document.getElementById("pending-documents");
        const complianceRateEl = document.getElementById("compliance-rate");
        const expiringSoonEl = document.getElementById("expiring-documents");

        const documents = [];

        // Open/close modal
        window.openUploadModal = () => {
          modal.style.display = "block";
          form.reset();
        };

        window.closeUploadModal = () => {
          modal.style.display = "none";
          form.reset();
        };

        modal.querySelector(".close-btn").onclick = closeUploadModal;
        window.onclick = (e) => {
          if (e.target === modal) closeUploadModal();
        };

        // Add PDF file input (if not already present)
        if (!form.querySelector("#pdfFile")) {
          const fileInput = document.createElement("input");
          fileInput.type = "file";
          fileInput.id = "pdfFile";
          fileInput.accept = "application/pdf";
          fileInput.required = true;
          form.insertBefore(
            fileInput,
            form.querySelector("button[type='submit']")
          );
        }

        // Submit form
        form.onsubmit = (e) => {
          e.preventDefault();

          const file = form.pdfFile.files[0];
          if (!file || file.type !== "application/pdf") {
            alert("Please upload a valid PDF file.");
            return;
          }

          const doc = {
            type: form.docType.value.trim(),
            number: form.docNumber.value.trim(),
            shipmentId: form.shipmentId.value.trim(),
            productName: form.productName.value.trim(),
            distribution: form.distribution.value.trim(),
            issueDate: form.issueDate.value,
            expiryDate: form.expiryDate.value,
            fileSize: (file.size / 1024).toFixed(2), // KB with 2 decimals
            file: file,
            status: "Pending Review",
            compliance: "Under Review",
          };

          documents.push(doc);
          renderDocuments();
          closeUploadModal();
        };

        function renderDocuments() {
          const search = searchInput.value.toLowerCase();
          const filterType = typeFilter.value.toLowerCase();
          const filterStatus = statusFilter.value.toLowerCase();
          const today = new Date();
          const soonDate = new Date();
          soonDate.setDate(today.getDate() + 7);

          tableBody.innerHTML = "";
          let compliantCount = 0;
          let expiringSoonCount = 0;
          let total = 0;
          let pending = 0;

          const uniqueTypes = new Set();
          const uniqueStatuses = new Set();

          documents.forEach((doc, index) => {
            const matchesSearch = [
              doc.type,
              doc.number,
              doc.shipmentId,
              doc.productName,
              doc.distribution,
            ].some((val) => val.toLowerCase().includes(search));
            const matchesType =
              filterType === "" || doc.type.toLowerCase() === filterType;
            const matchesStatus =
              filterStatus === "" || doc.status.toLowerCase() === filterStatus;

            if (matchesSearch && matchesType && matchesStatus) {
              const issueDateFormatted = new Date(
                doc.issueDate
              ).toLocaleDateString();
              const expiryDateFormatted = new Date(
                doc.expiryDate
              ).toLocaleDateString();

              const row = document.createElement("tr");
              row.innerHTML = `
          <td><strong>${doc.type}</strong><br>${doc.number}</td>
          <td>${doc.shipmentId}<br>${doc.productName}<br>${
                doc.distribution
              }</td>
          <td>Issued: ${issueDateFormatted}<br>Expires: ${expiryDateFormatted}</td>
          <td><span class="badge ${doc.status
            .toLowerCase()
            .replace(/ /g, "-")}">${doc.status}</span></td>
          <td><span class="badge ${doc.compliance
            .toLowerCase()
            .replace(/ /g, "-")}">${doc.compliance}</span></td>
          <td>${doc.fileSize} KB</td>
          <td>
            <button class="view-btn" onclick="alert('Preview not implemented')">👁️ View</button>
            <button class="download-btn" onclick="downloadPDF(${index})">⬇️ Download</button>
          </td>
        `;
              tableBody.appendChild(row);
            }

            total++;
            if (doc.status === "Pending Review") pending++;
            if (doc.compliance === "Compliant") compliantCount++;

            const expDate = new Date(doc.expiryDate);
            if (expDate <= soonDate) expiringSoonCount++;

            uniqueTypes.add(doc.type);
            uniqueStatuses.add(doc.status);
          });

          // Update stats
          totalDocEl.textContent = total;
          pendingReviewEl.textContent = pending;
          complianceRateEl.textContent = total
            ? `${Math.round((compliantCount / total) * 100)}%`
            : "0%";
          expiringSoonEl.textContent = expiringSoonCount;

          // Update filter options dynamically
          updateFilterOptions(typeFilter, uniqueTypes);
          updateFilterOptions(statusFilter, uniqueStatuses);
        }

        function updateFilterOptions(select, items) {
          const currentValues = new Set(
            Array.from(select.options).map((o) => o.value)
          );
          items.forEach((item) => {
            if (!currentValues.has(item)) {
              const option = document.createElement("option");
              option.value = item;
              option.textContent = item;
              select.appendChild(option);
            }
          });
        }

        // Download PDF file
        window.downloadPDF = (index) => {
          const file = documents[index].file;
          const url = URL.createObjectURL(file);
          const a = document.createElement("a");
          a.href = url;
          a.download = file.name;
          a.click();
          URL.revokeObjectURL(url);
        };

        // Filter event listeners
        [searchInput, typeFilter, statusFilter].forEach((el) =>
          el.addEventListener("input", renderDocuments)
        );

        // Initial render
        renderDocuments();
      }

      // ---------- Warehouse Page Logic ----------
      function initWarehousePage() {
        const modal = document.getElementById("addWarehouseModal");
        const openBtn = document.getElementById("addWarehouseBtn");
        const closeBtn = document.getElementById("closeWarehouseModal");
        const form = document.getElementById("warehouseForm");
        const searchInput = document.getElementById("searchWarehouse");
        const tableBody = document.getElementById("warehouseTableBody");

        function loadWarehouses() {
          fetch("warehouse.php")
            .then((res) => res.json())
            .then((data) => {
              tableBody.innerHTML = "";
              let totalCapacity = 0;

              data.forEach((wh) => {
                // Ensure capacity is a valid number
                let capacityNum = parseInt(wh.capacity);
                if (isNaN(capacityNum)) capacityNum = 0;
                totalCapacity += capacityNum;

                const row = `<tr>
            <td>${wh.name}</td>
            <td>${wh.location}</td>
            <td>${capacityNum} kg</td>
            <td>${wh.manager}</td>
            <td>${wh.type}</td>
          </tr>`;
                tableBody.innerHTML += row;
              });

              document.getElementById("totalWarehouses").textContent =
                data.length;
              document.getElementById("totalCapacity").textContent =
                totalCapacity + " kg";

              // For example, occupied space is 60% of total capacity (you can adjust this logic)
              const occupiedSpace = Math.floor(totalCapacity * 0.6);
              document.getElementById("occupiedSpace").textContent =
                occupiedSpace + " kg";
            });
        }

        openBtn.onclick = () => (modal.style.display = "block");
        closeBtn.onclick = () => (modal.style.display = "none");
        window.onclick = (e) => {
          if (e.target == modal) modal.style.display = "none";
        };

        form.addEventListener("submit", function (e) {
          e.preventDefault();
          const formData = new FormData(form);
          fetch("warehouse.php", {
            method: "POST",
            body: formData,
          })
            .then((res) => res.json())
            .then((response) => {
              if (response.success) {
                modal.style.display = "none";
                form.reset();
                loadWarehouses();
              } else {
                alert(response.error || "Failed to add warehouse");
              }
            });
        });

        searchInput.addEventListener("keyup", function () {
          const filter = searchInput.value.toLowerCase();
          const rows = tableBody.getElementsByTagName("tr");
          for (let i = 0; i < rows.length; i++) {
            const text = rows[i].textContent.toLowerCase();
            rows[i].style.display = text.includes(filter) ? "" : "none";
          }
        });

        loadWarehouses();
      }

      // ---------- Consumer Page Logic ----------
      function initConsumerPage() {
        // Elements
        const addBtn = document.querySelector(".add-consumer-btn");
        const modal = document.getElementById("addConsumerModal");
        const form = document.getElementById("consumerForm");
        const tbody = document.getElementById("consumerTableBody");
        const searchInput = document.querySelector(
          '.filter-row input[type="text"]'
        );
        const typeFilter = document.querySelectorAll(".filter-row select")[0];
        const statusFilter = document.querySelectorAll(".filter-row select")[1];

        const countCards = {
          farmer: document.getElementById("totalFarmers"),
          supplier: document.getElementById("totalSuppliers"),
          customer: document.getElementById("feedbackCount"),
          newThisMonth: document.getElementById("newThisMonth"),
        };

        if (
          !addBtn ||
          !modal ||
          !form ||
          !tbody ||
          !searchInput ||
          !typeFilter ||
          !statusFilter
        ) {
          console.warn("Consumer page elements missing");
          return;
        }

        // Load existing rows from the table into consumers array
        let consumers = [];
        const existingRows = tbody.querySelectorAll("tr");
        existingRows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          if (cells.length >= 5) {
            const name = cells[0].textContent.trim();
            const type = cells[1].textContent.trim().toLowerCase();
            const location = cells[2].textContent.trim();
            // Extract email and phone from the 4th cell
            const contactText = cells[3].textContent;
            const emailMatch = contactText.match(/📧\s*([^\n]+)/);
            const phoneMatch = contactText.match(/📞\s*([^\n]+)/);
            const email = emailMatch ? emailMatch[1].trim() : "";
            const phone = phoneMatch ? phoneMatch[1].trim() : "";
            const status = cells[4].textContent.trim().toLowerCase();

            consumers.push({ name, type, location, email, phone, status });
          }
        });

        // Add new consumer (from modal)
        addBtn.onclick = () => {
          modal.style.display = "flex";
        };
        const closeBtn = modal.querySelector(".close-btn");
        closeBtn.onclick = () => {
          modal.style.display = "none";
          form.reset();
        };

        function closeConsumerModal() {
          modal.style.display = "none";
          form.reset();
        }
        window.closeConsumerModal = closeConsumerModal;

        form.onsubmit = function (e) {
          e.preventDefault();

          const name = document.getElementById("consumerName").value.trim();
          const type = document
            .getElementById("consumerType")
            .value.toLowerCase();
          const email = document.getElementById("consumerEmail").value.trim();
          const phone = document.getElementById("consumerPhone").value.trim();
          const status = document
            .getElementById("consumerStatus")
            .value.toLowerCase();
          const location = document.getElementById("location").value.trim();

          consumers.push({ name, type, email, phone, location, status });
          updateTable();
          updateCards();
          closeConsumerModal();
        };

        // Filtering & Searching
        searchInput.addEventListener("input", updateTable);
        typeFilter.addEventListener("change", updateTable);
        statusFilter.addEventListener("change", updateTable);

        // Update table with filtered data
        function updateTable() {
          tbody.innerHTML = "";

          const search = searchInput.value.toLowerCase();
          const filterType = typeFilter.value.toLowerCase();
          const filterStatus = statusFilter.value.toLowerCase();

          consumers.forEach((c) => {
            const matchesSearch =
              c.name.toLowerCase().includes(search) ||
              c.email.toLowerCase().includes(search) ||
              c.phone.toLowerCase().includes(search) ||
              c.location.toLowerCase().includes(search);

            const matchesType =
              filterType === "filter by type" || c.type === filterType;
            const matchesStatus =
              filterStatus === "filter by status" || c.status === filterStatus;

            if (matchesSearch && matchesType && matchesStatus) {
              const tr = document.createElement("tr");
              tr.innerHTML = `
          <td>${c.name}</td>
          <td><span class="type-tag ${c.type}">${capitalize(c.type)}</span></td>
          <td>${c.location}</td>
          <td>📧 ${c.email}<br>📞 ${c.phone}</td>
          <td><span class="status-tag ${c.status}">${capitalize(
                c.status
              )}</span></td>
        `;
              tbody.appendChild(tr);
            }
          });
        }

        // Update summary cards counts
        function updateCards() {
          const totalFarmers = consumers.filter(
            (c) => c.type === "farmer"
          ).length;
          const totalSuppliers = consumers.filter(
            (c) => c.type === "supplier"
          ).length;
          const totalCustomers = consumers.filter(
            (c) => c.type === "customer"
          ).length;
          const newThisMonth = consumers.length; // you can adjust this logic later

          countCards.farmer.textContent = totalFarmers;
          countCards.supplier.textContent = totalSuppliers;
          countCards.customer.textContent = totalCustomers;
          countCards.newThisMonth.textContent = newThisMonth;
        }

        // Capitalize helper
        function capitalize(str) {
          if (!str) return "";
          return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Initialize table and cards display
        updateTable();
        updateCards();
      }
      loadContent("home");
    </script>
  </body>
</html>
