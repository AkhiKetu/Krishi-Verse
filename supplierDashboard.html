<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supplier Dashboard | Krishi-Verse</title>
    <link rel="stylesheet" href="supplierDashboard.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <!-- Leaflet CSS For Maps-->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script
      src="https://kit.fontawesome.com/a076d05399.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <h2 class="logo">Krishi-Verse</h2>
        <div class="user">
          <img src="supplier.png" alt="User" />
          <p id="displayUsername">
            Loading...<br /><span id="displayRole">Role</span>
          </p>
        </div>
        <nav>
          <ul>
            <li>
              <a href="#" data-page="supplier-home" class="active"
                ><i class="fas fa-home"></i> Home</a
              >
            </li>
            <li>
              <a href="#" data-page="supplier-crop"
                ><i class="fas fa-seedling"></i> Crops</a
              >
            </li>
            <li>
              <a href="#" data-page="supplier-inventory"
                ><i class="fas fa-warehouse"></i> Inventory</a
              >
            </li>
            <li>
              <a href="#" data-page="supplier-transportation"
                ><i class="fas fa-tools"></i> Transportation</a
              >
            </li>
            <li>
              <a href="#" data-page="supplier-market"
                ><i class="fas fa-dollar-sign"></i> Market Prices</a
              >
            </li>
            <li>
              <a href="#" data-page="supplier-weather"
                ><i class="fas fa-cloud"></i> Weather</a
              >
            </li>
            <li>
              <a href="#" data-page="supplier-packaging"
                ><i class="fas fa-box"></i> Packaging</a
              >
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <div class="main">
        <header>
          <div class="header-right">
            <a href="#" class="notification-btn">Notification</a>
            <a href="#" class="message-btn">Messages</a>
            <div class="profile-dropdown">
              <a href="#" class="profile-btn" onclick="toggleDropdown(event)"
                >Profile <i class="fas fa-caret-down"></i
              ></a>
              <div id="dropdown-menu" class="dropdown-content">
                <a href="#">Edit Profile</a>
                <a href="#">Settings</a>
              </div>
            </div>
            <a href="#" onclick="logout()" class="logout-btn">Logout</a>
          </div>
        </header>

        <section class="content">
          <!-- Dynamic content will be loaded here -->
        </section>
      </div>
    </div>

    <!-- Crop Modal -->
    <div id="cropModal" class="modal" style="display: none">
      <div class="modal-content">
        <h3 id="modalTitle">Add Crop</h3>
        <form id="cropForm">
          <input type="text" id="cropName" placeholder="Crop Name" required />
          <input type="text" id="cropType" placeholder="Crop Type" required />
          <input
            type="number"
            id="cropQuantity"
            placeholder="Quantity (kg)"
            required
          />
          <input
            type="text"
            id="cropStatus"
            placeholder="Status (e.g. Growing)"
            required
          />
          <select id="cropSeason" required>
            <option value="" disabled selected>Select Season</option>
            <option value="summer">Summer</option>
            <option value="winter">Winter</option>
            <option value="monsoon">Monsoon</option>
            <option value="full-year">Full Year</option>
          </select>
          <input type="date" id="cropDate" required />
          <div class="modal-actions">
            <button type="submit">Save</button>
            <button type="button" onclick="closeCropModal()">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Check login status
        if (localStorage.getItem("loggedIn") !== "true") {
          window.location.href = "login.html";
          return;
        }

        // Display username and role
        const username = localStorage.getItem("username") || "User";
        const role = localStorage.getItem("designation") || "supplier";

        document.getElementById(
          "displayUsername"
        ).innerHTML = `${username}<br><span>${formatRole(role)}</span>`;

        // Sidebar nav link click handler
        document.querySelectorAll("nav a").forEach((link) => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            const page = this.getAttribute("data-page");
            loadContent(page);
          });
        });

        // Load default page
        loadContent("supplier-home");
      });

      // Format role display
      function formatRole(role) {
        switch (role) {
          case "warehouseManager":
            return "Warehouse-Manager";
          case "supplier":
            return "Supplier";
          case "supplier-transportation":
            return "Transportation";
          case "distributor":
            return "Distributor";
          case "retailer":
            return "Retailer";
          default:
            return role;
        }
      }

      // Load page content and initialize its JS
      function loadContent(page) {
        fetch(`${page}.html?ts=${new Date().getTime()}`) // âœ… cache-busting
          .then((res) => {
            if (!res.ok) throw new Error("Network response was not ok");
            return res.text();
          })
          .then((html) => {
            const content = document.querySelector(".content");
            content.innerHTML = html;

            // Page-specific init functions
            if (page === "supplier-transportation") {
              initTransportationPage(content);
            } else if (page === "supplier-crop") {
              setupCropPage(content);
            } else if (page === "supplier-home") {
              initSupplierHomePage(content);
            } else if (page === "supplier-packaging") {
              initPackagingPage(content);
            } else if (page === "supplier-weather") {
              initWeatherPage(content); // âœ… initializes Weather page
            }
          })
          .catch(() => {
            document.querySelector(
              ".content"
            ).innerHTML = `<p>Error loading ${page}.</p>`;
          });
      }

      // Logout function
      function logout() {
        localStorage.removeItem("loggedIn");
        window.location.href = "index.html";
      }

      // Toggle profile dropdown
      function toggleDropdown(e) {
        e.preventDefault();
        document.getElementById("dropdown-menu").classList.toggle("show");
      }

      window.addEventListener("click", function (e) {
        if (!e.target.closest(".profile-dropdown")) {
          document.getElementById("dropdown-menu").classList.remove("show");
        }
      });

      function initWeatherPage(content) {
        console.log("Weather page initialized âœ…");
      }
      // Call this function after loading supplier-home.html
      function initSupplierHomePage(content) {
        console.log("Supplier Home Page Initialized âœ…");

        // Dummy data
        const dummyRoutes = 12;
        const dummyProducts = 8;
        const dummyTotalCost = 15200;

        // Update summary cards
        content.querySelector("#totalRoutes").textContent = dummyRoutes;
        content.querySelector("#totalProducts").textContent = dummyProducts;
        content.querySelector("#totalCost").textContent =
          dummyTotalCost + " BDT";

        // TRANSPORTATION COST OVER TIME (Line Chart)
        const costCtx = content
          .querySelector("#transportCostChart")
          .getContext("2d");
        new Chart(costCtx, {
          type: "line",
          data: {
            labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"],
            datasets: [
              {
                label: "Cost (BDT)",
                data: [1200, 1500, 1300, 1700, 1600, 1800, 2000],
                borderColor: "rgba(75, 192, 192, 1)",
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                fill: true,
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "top" },
              title: { display: true, text: "Transportation Cost Over Time" },
            },
            scales: { y: { beginAtZero: false } },
          },
        });

        // TRANSPORTATION TIME DISTRIBUTION (Pie Chart)
        const timeCtx = content
          .querySelector("#transportTimeChart")
          .getContext("2d");
        new Chart(timeCtx, {
          type: "pie",
          data: {
            labels: ["<1 hr", "1-2 hr", "2-3 hr", ">3 hr"],
            datasets: [
              {
                label: "Transport Time",
                data: [5, 3, 2, 2],
                backgroundColor: [
                  "rgba(255, 99, 132, 0.6)",
                  "rgba(54, 162, 235, 0.6)",
                  "rgba(255, 206, 86, 0.6)",
                  "rgba(75, 192, 192, 0.6)",
                ],
                borderColor: [
                  "rgba(255, 99, 132, 1)",
                  "rgba(54, 162, 235, 1)",
                  "rgba(255, 206, 86, 1)",
                  "rgba(75, 192, 192, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "right" },
              title: {
                display: true,
                text: "Transportation Time Distribution",
              },
            },
          },
        });

        // PRODUCT PRICES (Bar Chart)
        const priceCtx = content
          .querySelector("#productPriceChart")
          .getContext("2d");
        new Chart(priceCtx, {
          type: "bar",
          data: {
            labels: ["Tomato", "Carrot", "Potato", "Wheat", "Corn"],
            datasets: [
              {
                label: "Price (BDT/kg)",
                data: [50, 30, 25, 40, 35],
                backgroundColor: [
                  "rgba(255, 99, 132, 0.6)",
                  "rgba(54, 162, 235, 0.6)",
                  "rgba(255, 206, 86, 0.6)",
                  "rgba(75, 192, 192, 0.6)",
                  "rgba(153, 102, 255, 0.6)",
                ],
                borderColor: [
                  "rgba(255, 99, 132, 1)",
                  "rgba(54, 162, 235, 1)",
                  "rgba(255, 206, 86, 1)",
                  "rgba(75, 192, 192, 1)",
                  "rgba(153, 102, 255, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: true, text: "Product Prices" },
            },
            scales: { y: { beginAtZero: true } },
          },
        });
      }

      // Initialize Packaging Page
      function initPackagingPage(content) {
        const modal = content.querySelector("#packagingModal");
        const addBtn = content.querySelector("#addPackagingBtn");
        const form = content.querySelector("#packagingForm");
        const batchIdSelect = content.querySelector("#batchId");

        if (!modal || !addBtn || !form || !batchIdSelect) {
          console.error("Required packaging elements not found");
          return;
        }

        // Load batch IDs from products
        function loadBatchIds() {
          fetch("packaging.php?action=getBatchIds")
            .then((response) => response.json())
            .then((data) => {
              batchIdSelect.innerHTML =
                '<option value="">Select Batch ID</option>';
              data.forEach((product) => {
                batchIdSelect.innerHTML += `<option value="${product.productID}">${product.productID} - ${product.productName}</option>`;
              });
            })
            .catch((error) => console.error("Error loading batch IDs:", error));
        }

        // Load packaging data
        function loadPackagingData() {
          fetch("packaging.php?action=getAll")
            .then((response) => response.json())
            .then((data) => {
              const tableBody = content.querySelector("#packagingTableBody");
              if (!tableBody) return;

              tableBody.innerHTML = "";
              data.forEach((item) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td>${item.batch_id}</td>
                  <td>${item.product_name}</td>
                  <td>${item.packaging_type}</td>
                  <td>${item.weight}</td>
                  <td>${item.packaging_date}</td>
                  <td>${item.expire_date}</td>
                  <td>${item.storage_temp}</td>
                  <td>
                    <button onclick="editPackaging(${item.id})" class="edit-btn">Edit</button>
                    <button onclick="deletePackaging(${item.id})" class="delete-btn">Delete</button>
                  </td>
                `;
                tableBody.appendChild(row);
              });
            })
            .catch((error) =>
              console.error("Error loading packaging data:", error)
            );
        }

        // Show modal
        addBtn.onclick = function () {
          modal.style.display = "flex";
          form.reset();
          loadBatchIds();
          // Set default packaging date to today
          content.querySelector("#packagingDate").valueAsDate = new Date();
        };

        // Close modal
        window.closePackagingModal = function () {
          modal.style.display = "none";
        };

        // Close modal when clicking outside
        window.onclick = function (event) {
          if (event.target == modal) {
            modal.style.display = "none";
          }
        };

        let editingId = null; // Track which record is being edited

        // Handle form submission
        form.onsubmit = function (e) {
          e.preventDefault();

          const formData = {
            batch_id: content.querySelector("#batchId").value,
            packaging_type: content.querySelector("#packagingType").value,
            weight: content.querySelector("#weight").value,
            packaging_date: content.querySelector("#packagingDate").value,
            expire_date: content.querySelector("#expireDate").value,
            storage_temp: content.querySelector("#storageTemp").value,
            notes: content.querySelector("#notes").value,
          };

          // If editing, add the ID to formData
          if (editingId) {
            formData.id = editingId;
          }

          fetch("packaging.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                closePackagingModal();
                loadPackagingData();
                editingId = null; // Reset editing state
              } else {
                alert(
                  "Error saving packaging data: " +
                    (data.error || "Unknown error")
                );
              }
            })
            .catch((error) => console.error("Error:", error));
        };

        // Edit packaging
        window.editPackaging = function (id) {
          editingId = id; // Set the editing state

          // First load the batch IDs to populate the dropdown
          loadBatchIds();

          fetch(`packaging.php?action=get&id=${id}`)
            .then((response) => response.json())
            .then((data) => {
              content.querySelector("#batchId").value = data.batch_id;
              content.querySelector("#packagingType").value =
                data.packaging_type;
              content.querySelector("#weight").value = data.weight;
              content.querySelector("#packagingDate").value =
                data.packaging_date;
              content.querySelector("#expireDate").value = data.expire_date;
              content.querySelector("#storageTemp").value = data.storage_temp;
              content.querySelector("#notes").value = data.notes || "";
              modal.style.display = "flex";
            })
            .catch((error) => console.error("Error:", error));
        };

        // Delete packaging
        window.deletePackaging = function (id) {
          if (
            confirm("Are you sure you want to delete this packaging record?")
          ) {
            fetch(`packaging.php?action=delete&id=${id}`, { method: "DELETE" })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  loadPackagingData();
                } else {
                  alert("Error deleting packaging record");
                }
              })
              .catch((error) => console.error("Error:", error));
          }
        };

        // Initial load
        loadPackagingData();
      }

      //--transport Dummy Graph-----------
      function renderTransportationChart() {
        const ctx = document.getElementById("transportChart").getContext("2d");

        new Chart(ctx, {
          type: "line",
          data: {
            labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"],
            datasets: [
              {
                label: "Transportation Cost ($)",
                data: [1200, 1350, 1100, 1450, 1600, 1550, 1700],
                borderColor: "rgba(75, 192, 192, 1)",
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                fill: true,
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "top" },
              title: { display: true, text: "Monthly Transportation Cost" },
            },
            scales: { y: { beginAtZero: false } },
          },
        });
      }
      // Crop Chart (Dummy Data)
      function renderCropChart() {
        const ctx = document.getElementById("cropChart").getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Tomato", "Carrot", "Potato", "Wheat", "Corn"],
            datasets: [
              {
                label: "Quantity (kg)",
                data: [100, 50, 200, 150, 120],
                backgroundColor: [
                  "rgba(255, 99, 132, 0.6)",
                  "rgba(54, 162, 235, 0.6)",
                  "rgba(255, 206, 86, 0.6)",
                  "rgba(75, 192, 192, 0.6)",
                  "rgba(153, 102, 255, 0.6)",
                ],
                borderColor: [
                  "rgba(255, 99, 132, 1)",
                  "rgba(54, 162, 235, 1)",
                  "rgba(255, 206, 86, 1)",
                  "rgba(75, 192, 192, 1)",
                  "rgba(153, 102, 255, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: true, text: "Crop Quantity Overview" },
            },
            scales: { y: { beginAtZero: true } },
          },
        });
      }

      // ---------- Transportation Page Logic ----------
      function initTransportationPage() {
        const modal = document.getElementById("scheduleModal");
        const scheduleBtn = document.querySelector(".schedule-btn");
        const form = document.querySelector(".schedule-form");
        const tableBody = document.querySelector(".transport-table tbody");

        const summaryActiveRoutes = document.querySelector(
          ".summary-cards .card:nth-child(1) .value"
        );
        const summaryScheduledToday = document.querySelector(
          ".summary-cards .card:nth-child(1) .sub"
        );
        const availableVehiclesCount = document.querySelector(
          ".summary-cards .card:nth-child(2) .value"
        );

        const vehicleList = ["RT-001", "RT-002", "DC-003", "DC-004"];

        // Search bar
        const searchInput = document.getElementById("transportSearch");

        // GPS Map elements
        const gpsButton = document.getElementById("gpsButton");
        const mapContainer = document.getElementById("mapContainer"); // Container div that wraps #transportMap
        let map = null;
        let mapInitialized = false;

        if (!modal || !scheduleBtn || !form || !tableBody) {
          console.warn("Transportation page elements not found.");
          return;
        }

        // Open modal to add new transport
        scheduleBtn.onclick = () => {
          form.reset();
          modal.style.display = "block";
          form.setAttribute("data-editing", "false");
          form.editingRow = null;
        };

        // Close modal if clicked outside content
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.style.display = "none";
          }
        });

        // Close modal on (x) click
        modal.querySelector(".close").onclick = () => {
          modal.style.display = "none";
        };

        // Close modal on cancel button
        form.querySelector(".cancel-btn").onclick = () => {
          modal.style.display = "none";
        };

        // Handle form submit (Add/Edit)
        form.onsubmit = function (e) {
          e.preventDefault();

          const editing = form.getAttribute("data-editing") === "true";
          const editingRow = form.editingRow;

          const origin = form.origin.value.trim();
          const destination = form.destination.value.trim();
          const product = form.product.value;
          const weight = form.weight.value.trim();
          const vehicle = form.vehicle.value;
          const driver = form.driver.value;
          const date = form.date.value;
          const time = form.time.value;
          const priority = form.priority.value;
          const temperature = form.temperature.value;
          const humidity = form.humidity.value;
          const distanceKm = parseFloat(form.distance.value) || 0;

          if (
            !origin ||
            !destination ||
            !product ||
            !weight ||
            !vehicle ||
            !driver ||
            !date ||
            !time ||
            !priority ||
            !temperature ||
            !humidity
          ) {
            alert("Please fill in all required fields.");
            return;
          }

          const routeId =
            editing && editingRow
              ? editingRow.dataset.id
              : "TRP-" + Math.floor(Math.random() * 900 + 100);

          const routeText = `${origin} â†’ ${destination}<br><small>${product} (${weight})</small>`;
          const vehicleDriver = `ðŸš› ${vehicle}<br>ðŸ‘¤ ${driver}`;
          const scheduleText = `${date}<br>${time}`;
          const distance = `${distanceKm} km<br><small>ETA: ${Math.floor(
            Math.random() * 3 + 1
          )} hrs</small>`;
          const priorityTag = `<span class="priority ${priority.toLowerCase()}">${priority}</span>`;
          const statusTag = `<span class="status scheduled">Scheduled</span>`;
          const cost = `${(distanceKm * 15).toFixed(2)} BDT`;

          const rowHTML = `
      <td>${routeId}</td>
      <td>${routeText}</td>
      <td>${vehicleDriver}</td>
      <td>${scheduleText}</td>
      <td>${distance}</td>
      <td>${priorityTag}</td>
      <td>${statusTag}</td>
      <td>${cost}</td>
      <td>${temperature}</td>
      <td>${humidity}</td>
      <td>
        <button class="edit-btn">Edit</button>
        <button class="delete-btn">Delete</button>
      </td>
    `;

          if (editing && editingRow) {
            editingRow.innerHTML = rowHTML;
            editingRow.dataset.id = routeId;
          } else {
            const newRow = document.createElement("tr");
            newRow.innerHTML = rowHTML;
            newRow.dataset.id = routeId;
            tableBody.appendChild(newRow);
          }

          modal.style.display = "none";
          form.reset();
          updateSummaryCards();
          updateFleetStatus();
          bindEditDeleteButtons();
        };

        // Bind Edit and Delete buttons
        function bindEditDeleteButtons() {
          tableBody.querySelectorAll(".edit-btn").forEach((btn) => {
            btn.onclick = (e) => {
              const row = e.target.closest("tr");
              const cells = row.querySelectorAll("td");

              const html = cells[1].innerHTML;
              const [routePart, productPart] = html.split("<br><small>");
              const [originText, destinationText] = routePart
                .split("â†’")
                .map((s) => s.trim());
              const productName = productPart
                .replace(")</small>", "")
                .split("(")[0]
                .trim();
              const weight = productPart.match(/\(([^)]+)\)/)[1];

              form.setAttribute("data-editing", "true");
              form.editingRow = row;

              form.origin.value = originText;
              form.destination.value = destinationText;
              form.product.value = productName;
              form.weight.value = weight;
              form.vehicle.value = cells[2].innerText
                .split("\n")[0]
                .replace("ðŸš› ", "")
                .trim();
              form.driver.value = cells[2].innerText
                .split("\n")[1]
                .replace("ðŸ‘¤ ", "")
                .trim();
              form.date.value = cells[3].innerText.split("\n")[0];
              form.time.value = cells[3].innerText.split("\n")[1];
              form.priority.value = cells[5].innerText.trim();
              form.distance.value = parseFloat(cells[4].innerText) || "";
              form.temperature.value = cells[8].innerText;
              form.humidity.value = cells[9].innerText;

              modal.style.display = "block";
            };
          });

          tableBody.querySelectorAll(".delete-btn").forEach((btn) => {
            btn.onclick = (e) => {
              if (confirm("Are you sure you want to delete this route?")) {
                e.target.closest("tr").remove();
                updateSummaryCards();
                updateFleetStatus();
              }
            };
          });
        }

        // Update summary cards
        function updateSummaryCards() {
          const rows = tableBody.querySelectorAll("tr");
          const today = new Date().toISOString().split("T")[0];
          let scheduledToday = 0;

          rows.forEach((row) => {
            const scheduleDate = row.cells[3].innerText.split("\n")[0];
            if (scheduleDate === today) scheduledToday++;
          });

          summaryActiveRoutes.textContent = rows.length;
          summaryScheduledToday.textContent = `${scheduledToday} scheduled for today`;
        }

        // Update available vehicles count
        function updateFleetStatus() {
          const usedVehicles = Array.from(tableBody.querySelectorAll("tr")).map(
            (row) =>
              row.cells[2].innerText.split("\n")[0].replace("ðŸš› ", "").trim()
          );
          const available = vehicleList.filter(
            (v) => !usedVehicles.includes(v)
          );
          availableVehiclesCount.textContent = available.length;
        }

        // Search functionality
        if (searchInput) {
          searchInput.addEventListener("keyup", () => {
            const filter = searchInput.value.toLowerCase();
            const rows = tableBody.getElementsByTagName("tr");
            Array.from(rows).forEach((row) => {
              const text = row.innerText.toLowerCase();
              row.style.display = text.includes(filter) ? "" : "none";
            });
          });
        }

        // GPS Map toggle and initialization
        if (gpsButton && mapContainer) {
          gpsButton.addEventListener("click", function () {
            if (
              mapContainer.style.display === "none" ||
              !mapContainer.style.display
            ) {
              mapContainer.style.display = "block";

              if (!mapInitialized) {
                map = L.map("transportMap").setView([23.685, 90.3563], 7);
                L.tileLayer(
                  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                  {
                    attribution:
                      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                  }
                ).addTo(map);
                mapInitialized = true;
              } else {
                map.invalidateSize(); // Fix map display after container shown again
              }
            } else {
              mapContainer.style.display = "none";
            }
          });
        }

        // Initial updates
        updateSummaryCards();
        updateFleetStatus();
        bindEditDeleteButtons();
      }

      // Initialize after DOM loads
      document.addEventListener("DOMContentLoaded", () => {
        initTransportationPage();
      });

      // -------------------- Crop Page Logic --------------------
      function setupCropPage(content) {
        const cropTableBody = content.querySelector("#cropTableBody");
        const addCropBtn = content.querySelector("#addCropBtn");
        const cropModal = document.getElementById("cropModal");
        const cropForm = document.getElementById("cropForm");

        if (!addCropBtn || !cropForm || !cropTableBody) {
          console.warn("Required elements not found in crop page.");
          return;
        }

        let editingRow = null;

        addCropBtn.onclick = () => {
          editingRow = null;
          cropForm.reset();
          document.getElementById("modalTitle").textContent = "Add Crop";
          cropModal.style.display = "flex";
        };

        cropForm.onsubmit = function (e) {
          e.preventDefault();

          const seasonSelect = document.getElementById("cropSeason");
          const seasonValue = seasonSelect.value;
          const seasonLabel = {
            summer: "Summer",
            winter: "Winter",
            monsoon: "Monsoon",
            "full-year": "Full Year",
          }[seasonValue];

          const crop = {
            name: document.getElementById("cropName").value,
            type: document.getElementById("cropType").value,
            quantity: document.getElementById("cropQuantity").value,
            status: document.getElementById("cropStatus").value,
            date: document.getElementById("cropDate").value,
            season: seasonLabel || "All",
          };

          const newRow = renderCropRow(crop);
          if (editingRow) {
            editingRow.replaceWith(newRow);
          } else {
            cropTableBody.appendChild(newRow);
          }

          cropModal.style.display = "none";
          filterTable();
        };

        function filterTable() {
          const seasonFilter = content.querySelector("#seasonFilter");
          if (!seasonFilter) return;
          const selected = seasonFilter.value;
          const rows = cropTableBody.querySelectorAll("tr");
          rows.forEach((row) => {
            const season = row.getAttribute("data-season");
            row.style.display =
              selected === "All" || season === selected ? "" : "none";
          });
        }

        if (content.querySelector("#seasonFilter")) {
          content
            .querySelector("#seasonFilter")
            .addEventListener("change", filterTable);
        }
        filterTable();

        // Crop row render helper
        function renderCropRow(crop) {
          const row = document.createElement("tr");
          row.setAttribute("data-season", crop.season);
          row.innerHTML = `
      <td>${crop.name}</td>
      <td>${crop.type}</td>
      <td>${crop.quantity}</td>
      <td>${crop.status}</td>
      <td>${crop.date}</td>
      <td>${crop.season}</td>
      <td>
        <button onclick="editCrop(this)" class="edit-btn">Edit</button>
        <button onclick="deleteCrop(this)" class="delete-btn">Delete</button>
      </td>
    `;
          return row;
        }

        // Edit crop button handler
        window.editCrop = function (button) {
          const row = button.closest("tr");
          editingRow = row;
          document.getElementById("modalTitle").textContent = "Edit Crop";
          document.getElementById("cropName").value = row.cells[0].textContent;
          document.getElementById("cropType").value = row.cells[1].textContent;
          document.getElementById("cropQuantity").value =
            row.cells[2].textContent;
          document.getElementById("cropStatus").value =
            row.cells[3].textContent;
          document.getElementById("cropDate").value = row.cells[4].textContent;
          const season = row.cells[5].textContent
            .toLowerCase()
            .replace(" ", "-");
          document.getElementById("cropSeason").value = season;
          document.getElementById("cropModal").style.display = "flex";
        };

        // Delete crop button handler
        window.deleteCrop = function (button) {
          if (confirm("Are you sure you want to delete this crop?")) {
            const row = button.closest("tr");
            row.remove();
          }
        };

        // Close modal if clicking outside
        window.addEventListener("click", function (e) {
          const cropModal = document.getElementById("cropModal");
          if (e.target === cropModal) {
            cropModal.style.display = "none";
          }
        });
      }
    </script>
  </body>
</html>
