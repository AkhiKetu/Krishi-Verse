<h2>Inventory Management</h2>
<p>Manage your product inventory across warehouses</p>

<!-- Action Bar -->
<div class="actions-bar">
  <input id="inventorySearch" type="text" placeholder="Search inventory..." />
  <button id="addInventoryBtn">+ New Inventory</button>
</div>

<!-- Inventory Table -->
<div class="table-container">
  <h3>Inventory Records</h3>
  <table id="inventoryTable">
    <thead>
      <tr>
        <th>Batch ID</th>
        <th>Product</th>
        <th>Main Storage</th>
        <th>Warehouse</th>
        <th>Packed</th>
        <th>Unpacked</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Dynamic rows loaded by JS -->
    </tbody>
  </table>
</div>

<!-- Add/Edit Inventory Modal -->
<div id="inventoryModal" class="modal">
  <div class="modal-content">
    <span id="closeInventoryModal" class="close">&times;</span>
    <h3>Add/Edit Inventory</h3>
    <form id="inventoryForm">
      <input type="hidden" name="id" id="inventoryID" />

      <label for="productSelect">Product</label>
      <select name="product" id="productSelect" required>
        <option value="" disabled selected>Select Product</option>
      </select>

      <label for="mainStorage">Main Storage (kg)</label>
      <input
        type="number"
        name="mainStorage"
        id="mainStorage"
        placeholder="e.g., 1000"
        step="0.01"
        required
      />

      <label for="warehouseSelect">Warehouse</label>
      <select name="warehouse" id="warehouseSelect" required>
        <option value="" disabled selected>Select Warehouse</option>
      </select>

      <label for="inWarehouse">Packed (kg)</label>
      <input
        type="number"
        name="inWarehouse"
        id="inWarehouse"
        step="0.01"
        required
      />

      <label for="lastAvailable">Unpacked (kg)</label>
      <input
        type="number"
        name="lastAvailable"
        id="lastAvailable"
        step="0.01"
        readonly
      />

      <div class="modal-actions">
        <button type="button" class="cancel-btn">Cancel</button>
        <button type="submit">Save Inventory</button>
      </div>
    </form>
  </div>
</div>

<script>
// --- Dynamic Inventory Management for Admin ---

const inventoryTable = document.getElementById("inventoryTable").querySelector("tbody");
const productSelect = document.getElementById("productSelect");
const warehouseSelect = document.getElementById("warehouseSelect");
const inventoryForm = document.getElementById("inventoryForm");
const inventoryModal = document.getElementById("inventoryModal");
const addInventoryBtn = document.getElementById("addInventoryBtn");
const closeInventoryModal = document.getElementById("closeInventoryModal");

// Open modal
addInventoryBtn.addEventListener("click", () => {
  inventoryForm.reset();
  document.getElementById("inventoryID").value = "";
  inventoryModal.style.display = "block";
});

// Close modal
closeInventoryModal.addEventListener("click", () => {
  inventoryModal.style.display = "none";
});

// Fetch products and warehouses
async function loadDropdowns() {
  const prodRes = await fetch("admin-inventory.php?products=1");
  const prodData = await prodRes.json();
  if (prodData.success) {
    productSelect.innerHTML = '<option value="" disabled selected>Select Product</option>';
    prodData.products.forEach(p => {
      productSelect.innerHTML += `<option value="${p.productID}">${p.productName}</option>`;
    });
  }

  const whRes = await fetch("admin-inventory.php?warehouses=1");
  const whData = await whRes.json();
  if (whData.success) {
    warehouseSelect.innerHTML = '<option value="" disabled selected>Select Warehouse</option>';
    whData.warehouses.forEach(w => {
      warehouseSelect.innerHTML += `<option value="${w.id}">${w.name}</option>`;
    });
  }
}

// Load inventory list
async function loadInventory() {
  const res = await fetch("admin-inventory.php");
  const data = await res.json();
  if (data.success) {
    inventoryTable.innerHTML = "";
    data.inventory.forEach(item => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${item.id}</td>
        <td>${item.productName}</td>
        <td>${item.main_storage}</td>
        <td>${item.warehouseName}</td>
        <td>${item.in_warehouse}</td>
        <td>${item.last_available}</td>
        <td>
          <button onclick="editInventory(${item.id}, '${item.product_id}', '${item.warehouse_id}', ${item.main_storage}, ${item.in_warehouse}, ${item.last_available})">Edit</button>
          <button onclick="deleteInventory(${item.id})">Delete</button>
        </td>
      `;
      inventoryTable.appendChild(row);
    });
  }
}

// Edit inventory
function editInventory(id, product_id, warehouse_id, main_storage, in_warehouse, last_available) {
  inventoryModal.style.display = "block";
  document.getElementById("inventoryID").value = id;
  productSelect.value = product_id;
  warehouseSelect.value = warehouse_id;
  document.getElementById("mainStorage").value = main_storage;
  document.getElementById("inWarehouse").value = in_warehouse;
  document.getElementById("lastAvailable").value = last_available;
}

// Delete inventory
async function deleteInventory(id) {
  if (!confirm("Are you sure you want to delete this inventory?")) return;
  const res = await fetch("admin-inventory.php", {
    method: "POST",
    body: JSON.stringify({ action: "delete", id }),
  });
  const data = await res.json();
  if (data.success) loadInventory();
  else alert(data.message);
}

// Handle form submit
inventoryForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = {
    action: "save",
    id: document.getElementById("inventoryID").value,
    product_id: productSelect.value,
    warehouse_id: warehouseSelect.value,
    main_storage: parseFloat(document.getElementById("mainStorage").value),
    in_warehouse: parseFloat(document.getElementById("inWarehouse").value),
    last_available: parseFloat(document.getElementById("lastAvailable").value),
  };

  const res = await fetch("admin-inventory.php", {
    method: "POST",
    body: JSON.stringify(formData),
  });

  const data = await res.json();
  if (data.success) {
    inventoryModal.style.display = "none";
    loadInventory();
  } else {
    alert(data.message);
  }
});

// Initialize
loadDropdowns();
loadInventory();
</script>
