<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Warehouse Inventory</title>
<link rel="stylesheet" href="warehouse.css">
</head>
<body>

<!--Admin-level inventory management across all warehouses-->

<div class="main">
  <div class="content">
    <h2>Inventory Management</h2>
    <p>Manage your product inventory across warehouses</p>

    <!-- Action Bar -->
    <div class="actions-bar">
      <input id="inventorySearch" type="text" placeholder="Search inventory..." />
      <button id="addInventoryBtn">+ New Inventory</button>
    </div>

    <!-- Inventory Table(data) -->
    <div class="table-container">
      <table id="inventoryTable" class="inventory-table">
        <thead>
          <tr>
            <th>Batch ID</th>
            <th>Product</th>
            <th>Main Storage</th>
            <th>Warehouse</th>
            <th>Packed</th>
            <th>Unpacked</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add or Edit Inventory Modal -->
<div id="inventoryModal" class="modal">
  <div class="modal-content">
    <span id="closeInventoryModal" class="close">&times;</span>
    <h3>Add/Edit Inventory</h3>
    <form id="inventoryForm">
      <input type="hidden" id="inventoryID" />
      <label>Product</label>
      <select id="productSelect" required><option value="">Select Product</option></select>

      <label>Main Storage (kg)</label>
      <input type="number" id="mainStorage" step="0.01" required />

      <label>Warehouse</label>
      <select id="warehouseSelect" required><option value="">Select Warehouse</option></select>

      <label>Packed (kg)</label>
      <input type="number" id="inWarehouse" step="0.01" required />

      <label>Unpacked (kg)</label>
      <input type="number" id="lastAvailable" step="0.01" readonly />

      <div class="modal-actions">
        <button type="button" class="cancel-btn">Cancel</button>
        <button type="submit">Save Inventory</button>
      </div>
    </form>
  </div>
</div>

<script>
// ================ Inventory JS ================
const modal = document.getElementById('inventoryModal');
const addBtn = document.getElementById('addInventoryBtn');
const closeBtn = document.getElementById('closeInventoryModal');
const cancelBtn = modal.querySelector('.cancel-btn');
const form = document.getElementById('inventoryForm');
let inventoryData = [];

// Open modal
addBtn.onclick = () => {
  form.reset();
  document.getElementById('inventoryID').value = '';
  modal.style.display = 'block';
  fetchDropdowns();
};

// Close modal
closeBtn.onclick = cancelBtn.onclick = () => modal.style.display = 'none';
window.onclick = e => { if (e.target == modal) modal.style.display = 'none'; };

// Fetch the products and warehouses for dropdowns
function fetchDropdowns() {
  fetch('warehouse_inventory.php?products=1')
    .then(res => res.json())
    .then(data => {
      if(data.success) {
        const productSelect = document.getElementById('productSelect');
        productSelect.innerHTML = '<option value="">Select Product</option>';
        data.products.forEach(p => {
          productSelect.innerHTML += `<option value="${p.productID}">${p.productName}</option>`;
        });
      }
    });

  fetch('warehouse_inventory.php?warehouses=1')
    .then(res => res.json())
    .then(data => {
      if(data.success) {
        const warehouseSelect = document.getElementById('warehouseSelect');
        warehouseSelect.innerHTML = '<option value="">Select Warehouse</option>';
        data.warehouses.forEach(w => {
          warehouseSelect.innerHTML += `<option value="${w.id}">${w.name}</option>`;
        });
      }
    });
}

// Fetch inventory list
function loadInventory() {
  fetch('warehouse_inventory.php')
    .then(res => res.json())
    .then(data => {
      if(data.success) {
        inventoryData = data.inventory;
        const tbody = document.querySelector('#inventoryTable tbody');
        tbody.innerHTML = '';
        inventoryData.forEach(item => {
          tbody.innerHTML += `
            <tr>
              <td>${item.id}</td>
              <td>${item.productName}</td>
              <td>${item.main_storage}</td>
              <td>${item.warehouseName}</td>
              <td>${item.in_warehouse}</td>
              <td>${item.last_available}</td>
              <td>
                <div class="inventory-actions">
                  <button onclick="editInventory(${item.id})">Edit</button>
                  <button onclick="deleteInventory(${item.id})">Delete</button>
                </div>
              </td>
            </tr>`;
        });
      }
    });
}


/*
 // inv edit (1st version)

 function editInventory(id) {
     for (let i = 0; i < inventoryData.length; i++) {
         if (inventoryData[i].id === id) {
             document.getElementById("inventoryID").value = inventoryData[i].id;
             document.getElementById("productSelect").value = inventoryData[i].product_id;
             document.getElementById("mainStorage").value = inventoryData[i].main_storage;
             document.getElementById("warehouseSelect").value = inventoryData[i].warehouse_id;
             document.getElementById("inWarehouse").value = inventoryData[i].in_warehouse;
             document.getElementById("lastAvailable").value = inventoryData[i].last_available;
             modal.style.display = "block";
             fetchDropdowns();
             break;
         }
     }
 }
*/


// Edit inventory (edited)
function editInventory(id) {
  const item = inventoryData.find(i => i.id === id);
  if(item) {
    document.getElementById('inventoryID').value = item.id;
    document.getElementById('productSelect').value = item.product_id;
    document.getElementById('mainStorage').value = item.main_storage;
    document.getElementById('warehouseSelect').value = item.warehouse_id;
    document.getElementById('inWarehouse').value = item.in_warehouse;
    document.getElementById('lastAvailable').value = item.last_available;
    modal.style.display = 'block';
    fetchDropdowns();
  }
}




// Delete inventory
function deleteInventory(id) {
  if(confirm('Are you sure?')) {
    fetch('warehouse_inventory.php', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({action:'delete', id})
    })
    .then(res => res.json())
    .then(data => { alert(data.message); loadInventory(); });
  }
}

// Form submit
form.onsubmit = e => {
  e.preventDefault();
  const payload = {
    action: 'save',
    id: document.getElementById('inventoryID').value,
    product_id: document.getElementById('productSelect').value,
    warehouse_id: document.getElementById('warehouseSelect').value,
    main_storage: document.getElementById('mainStorage').value,
    in_warehouse: document.getElementById('inWarehouse').value
  };
  fetch('warehouse_inventory.php', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => { alert(data.message); modal.style.display='none'; loadInventory(); });
};

document.getElementById("mainStorage").addEventListener("input", function () {
     const main = parseFloat(document.getElementById("mainStorage").value) || 0;
     const packed = parseFloat(document.getElementById("inWarehouse").value) || 0;
     document.getElementById("lastAvailable").value = (main - packed).toFixed(2);
 });

 document.getElementById("inWarehouse").addEventListener("input", function () {
     const main = parseFloat(document.getElementById("mainStorage").value) || 0;
     const packed = parseFloat(document.getElementById("inWarehouse").value) || 0;
     document.getElementById("lastAvailable").value = (main - packed).toFixed(2);
 });


// Update unpacked field dynamically
document.getElementById('mainStorage').oninput = document.getElementById('inWarehouse').oninput = () => {
  const main = parseFloat(document.getElementById('mainStorage').value) || 0;
  const packed = parseFloat(document.getElementById('inWarehouse').value) || 0;
  document.getElementById('lastAvailable').value = (main - packed).toFixed(2);
};

// Initial load
loadInventory();
</script>

</body>
</html>
